---
# subtitle: "____"
title: "United in Diversity, Divided by Algorithms?"
# subtitle: "Ad Delivery Algorithms in the 2024 EP elections"
author: "Ad Delivery Algorithms in the 2024 European Parliament elections"
# date: "Final Report"
output: 
    pagedreport::paged_windmill:
      number_sections: false
      logo: "https://upload.wikimedia.org/wikipedia/commons/9/9e/Blank.svg"
      front_img: "report_cover.png"
      img_to_dark: TRUE
      logo_to_white: TRUE
knit: pagedown::chrome_print
main-color: "#6cabdd"
---

<style>

.percentage-box {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
  margin-right: 15px;
}

.percentage {
  font-size: 2em;
  font-weight: bold;
  color: #D9534F;
  margin-right: 15px;
}

.text-box {
  font-size: 1em;
}

.separator {
  margin: 20px 0;
  border-bottom: 1px solid #ddd;
}

.flex-container {
  display: flex;
  flex-direction: column;
}

.plot-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 20px;
}

.plot-text {
  width: 45%;
}

.plot-figure {
  width: 50%;
}


#toc {
  background-color: #f8f9fa; /* Light grey background */
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 30px;
  width: auto;
}

#toc h2 {
  font-size: 1.5em;
  font-weight: bold;
  color: #333;
  margin-top: 0;
}

#toc ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#toc ul ul {
  margin-left: 20px;
}

#toc li {
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
}

#toc a {
  text-decoration: none;
  color: #337ab7;
  font-weight: 500;
}

#toc a:hover {
  text-decoration: underline;
}

.toc-page-number {
  color: #777;
  font-weight: normal;
  margin-left: 10px;
  flex-shrink: 0;
}

p {
    text-align: justify;
}

</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var tocItems = document.querySelectorAll("#toc a");
  tocItems.forEach(function(item) {
    var target = document.querySelector(item.getAttribute("href"));
    if (target) {
      var pageNumber = Math.floor((target.offsetTop / window.innerHeight) + 1);
      item.nextElementSibling.textContent = ' - - - - - - - - - - - ' + pageNumber;
    }
  });
});
</script>


```{r, results='asis', echo = F}
toc_html <- '
<div id="toc">
  <h2>Table of Contents</h2>
  <ul>
    <li><a href="#researchers">1. Researchers</a><span class="toc-page-number">- - - - - - - - - - - 3</span></li>
    <li><a href="#executive-summary">2. Executive Summary</a><span class="toc-page-number">- - - - - - - - - - - 2</span>
    <li><a href="#introduction">3. Introduction</a><span class="toc-page-number">- - - - - - - - - - - 6</span></li>
    <li><a href="#overview">4. Overview of Parties</a><span class="toc-page-number">- - - - - - - - - - - 7</span>
    <li><a href="#results">5. Results</a><span class="toc-page-number">- - - - - - - - - - - 10</span></li>
    <li><a href="#conclusions">6. Conclusion</a><span class="toc-page-number">- - - - - - - - - - - 11</span></li>
    <li><a href="#recommendations">7. Recommendations</a><span class="toc-page-number">- - - - - - - - - - - 12</span></li>
    <li><a href="#implementation">8. Implementation</a><span class="toc-page-number">- - - - - - - - - - - 13</span></li>
    <li><a href="#methodology">9. Methodology and Hypothesis Testing</a><span class="toc-page-number">- - - - - - - - - - - 14</span>

  </ul>
</div>
'

shiny::HTML(toc_html)

```



```{r setup, include=FALSE}
library(tidyverse)
library(htmltools)
library(tidytext)  # For reorder_within

options(scipen = 999)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = 'asis')

source("utils.R")





# ov %>% 
#   mutate(post_engagements = as.numeric(post_engagements)) %>% 
#   group_by(cntry) %>% 
#   mutate(price = scale(price)) %>% 
#   ungroup() %>% 
#   ggplot(aes(post_engagements, price)) +
#   geom_point() +
#   scale_x_log10()
```

# Researchers

The research team for this study includes scholars from a range of academic institutions across Europe and North America. Their combined expertise spans algorihtmic governance, political communication, and electoral behavior. They made this comprehensive analysis of ad delivery algorithms in the 2024 European Parliament elections possible.

```{r}
library(gt)

# Create a data frame with authors and affiliations
authors_data <- tibble::tibble(
  Name = c(
    "Andrea Ceron", 
    "Anamaria Dutceac Segesten", 
    "Benjamin Guinaudeau", 
    "Christina Gahn", 
    "Claes de Vreese", 
    "Fabio Votta", 
    "James P. Cross", 
    "Jan Zilinsky", 
    "Linn Sandberg", 
    "Mads Fuglsang Hove", 
    "Marton Bene", 
    "Ruth Dassonneville", 
    "Simon Kruschinski", 
    "Tom Dobber"
  ),
  Affiliation = c(
    "University of Milan", 
    "Lund University", 
    "New York University", 
    "University of Vienna", 
    "University of Amsterdam", 
    "University of Amsterdam", 
    "University College Dublin", 
    "University of Munich", 
    "Lund University", 
    "University of Amsterdam", 
    "Hungarian Academy of Sciences", 
    "University of Montreal", 
    "Johannes Gutenberg University Mainz", 
    "University of Amsterdam"
  )
)

# Create a gt table
authors_data %>%
  gt() %>%
  tab_header(
    title = md("**Researchers and Affiliations**")
  ) %>%
  cols_label(
    Name = "Researcher",
    Affiliation = "Affiliation"
  ) %>%
  tab_options(
    table.font.size = px(12),
    table.width = pct(100)
  ) %>%
  # data_color(
  #   columns = vars(Name,Affiliation),
  #   colors = scales::col_factor(
  #     palette = "Blues", domain = authors_data$Affiliation
  #   )
  # ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())
  )

```


# Executive Summary

This study seeks to understand how Facebook's ad delivery algorithms affected the pricing and distribution of political advertisements during the 2024 European Parliament elections. By working with political parties across the EU to place neutral "get-out-the-vote" ads, we've uncovered significant insights into potential biases in ad pricing and delivery.


### Country Differences



The price of reaching voters through Facebook ads varies dramatically across countries, with a striking 321% difference between the highest and lowest average prices. This means that *a campaign that reaches 100 000 voters in one country might only reach 23 500 in another*.



```{r}

pacman::p_load(tidyverse, knitr, kableExtra, lme4)


overview <- readRDS("data/thedat.rds")  %>% 
  mutate(page_likes = ifelse(party == "SPD",194422,page_likes)) %>% 
  mutate(european = party %in% c("ALDE", "ECPM", "EGP"))   %>% 
  mutate(post_engagement = as.numeric(post_engagements)) %>% 
  mutate(engagement = ifelse(is.na(post_engagement), 0, post_engagement))  

overview <- overview %>% 
  mutate_at(vars("last7days_spend", "last30days_spend", "last90days_spend", "historic_spend"), 
            ~log((.x / 1000) + 1)) %>%
  rename_at(vars("last7days_spend", "last30days_spend", "last90days_spend", "historic_spend"), ~paste0(., "2")) %>%
  # Keep original variables
  bind_cols(overview %>% select(last7days_spend, last30days_spend, last90days_spend, historic_spend)) %>% 
  mutate(engagement = engagement / 10)
```

```{r, fig.width=15, fig.height=10}
ov <- overview %>% 
  filter(starts == as.Date("2024-04-29")) %>%
  # filter(starts %in% c(as.Date("2024-04-29"), as.Date("2024-04-30"))) %>% 
  filter(party != "Les Engagés")




parties_had_to_excluded <- overview %>% 
  select(party) %>% 
  anti_join(ov %>% select(party)) %>% 
  distinct(party) %>% 
  pull(party)

overview <- overview %>% 
  mutate(cntry2 = case_when(
    party %in% parties_had_to_excluded ~ NA,
    T ~ cntry
  ))

```


```{r}

# Calculate average price and reach for each country
country_avg_prices_reach <- ov %>%
  group_by(cntry) %>%
  summarize(avg_price = mean(price), 
            avg_reach = mean(reach)) %>%
  arrange(cntry)

# Function to calculate price and reach differences
calculate_price_and_reach_differences <- function(data) {
  n <- nrow(data)
  country_combinations <- combn(seq_len(n), 2, simplify = FALSE)
  
  results <- map_dfr(country_combinations, function(pair) {
    idx1 <- pair[1]
    idx2 <- pair[2]
    
    country1 <- data$cntry[idx1]
    country2 <- data$cntry[idx2]
    
    price1 <- data$avg_price[idx1]
    price2 <- data$avg_price[idx2]
    
    reach1 <- data$avg_reach[idx1]
    reach2 <- data$avg_reach[idx2]
    
    price_diff <- price1 - price2
    reach_diff <- reach1 - reach2
    
    tibble(
      country1 = country1,
      country2 = country2,
      price_difference = price_diff,
      percentage_difference_original = (price_diff / price2) * 100,
      percentage_difference_lower = (price_diff / min(price1, price2)) * 100,
      percentage_difference_higher = (price_diff / max(price1, price2)) * 100,
      reach_difference = reach_diff,
      reach_diff_original = (reach_diff / reach2) * 100,
      reach_diff_lower = (reach_diff / min(reach1, reach2)) * 100,
      reach_diff_higher = (reach_diff / max(reach1, reach2)) * 100
    )
  })
  
  results %>% arrange(desc(abs(price_difference)))
}

# Use the function to calculate price and reach differences
price_and_reach_differences <- calculate_price_and_reach_differences(country_avg_prices_reach)

# View the results
# price_and_reach_differences

```

```{r}
price_diff_lab <- glue::glue(paste0(round(mean(abs(price_and_reach_differences$price_difference)), 2)))
perc_max_lab <- paste0(round(max(abs(price_and_reach_differences$percentage_difference_lower))), "%")
perc_avg_lab <- paste0(round(mean(abs(price_and_reach_differences$percentage_difference_lower))), "%")
reach_diff_lab <- paste0(scales::number(round(mean(abs(price_and_reach_differences$reach_difference)))))
reach_max_lab <- paste0(scales::number(round(max(abs(price_and_reach_differences$reach_difference)))))

shiny::HTML(percentage_section(data.frame(
  Percentage = c(perc_avg_lab, perc_max_lab),
  Title = c("Average Price Disparity Between Countries",
            "Maximum Price Disparity Between Countries"),
  Subtitle = c(
    glue::glue("On average, prices between countries differ by {price_diff_lab} EUR or {perc_avg_lab}. This leads to a difference of {reach_diff_lab} people being reached on average."),
    glue::glue("Highest price vs. lowest (Denmark vs Hungary). This leads to a difference of {reach_max_lab} people being reached between the two countries on average.")),
  stringsAsFactors = FALSE
)))
```


### Audience Differences

```{r}
# Load necessary libraries
library(tidyverse)

# Calculate average price and reach for each audience within each country
country_audience_avg_prices <- ov %>%
  group_by(cntry, audience) %>%
  summarize(avg_price = mean(price),
            avg_reach = mean(reach)) %>%
  arrange(cntry, audience)

# Function to calculate price differences by audience, with "No Targeting" as the base
calculate_audience_price_differences <- function(prices) {
  # Iterate over unique countries
  unique_countries <- unique(prices$cntry)
  
  results <- map_dfr(unique_countries, function(country) {
    # Filter data for the current country
    country_data <- prices %>% filter(cntry == country)
    
    # Check if "No Targeting" exists in the data for this country
    no_targeting_data <- country_data %>% filter(audience == "No Targeting ad")
    
    # If "No Targeting" is present, compare it to all other audiences
    if (nrow(no_targeting_data) == 1) {
      base_price <- no_targeting_data$avg_price
      base_reach <- no_targeting_data$avg_reach
      
      # Filter out "No Targeting" for comparisons and calculate differences
      country_data %>%
        filter(audience != "No Targeting") %>%
        mutate(
          price_difference = avg_price - base_price,
          reach_difference = avg_reach - base_reach,
          percentage_price_difference = (price_difference / base_price) * 100,
          percentage_reach_difference = (reach_difference / base_reach) * 100
        ) %>%
        select(cntry, audience, price_difference, reach_difference, percentage_price_difference, percentage_reach_difference)
    }
  })
  
  # Arrange the results by descending absolute price differences
  results %>% arrange(desc(abs(price_difference)))
}

# Calculate and display price differences by audience with "No Targeting" as the base
audience_price_differences <- calculate_audience_price_differences(country_audience_avg_prices)

# View the results
# audience_price_differences

# View the results
# audience_price_differences

price_diff_lab <- glue::glue(paste0(round(mean(abs(audience_price_differences$price_difference)), 2)))
perc_max_lab <- paste0(round(max(abs(audience_price_differences$percentage_price_difference))), "%")
perc_avg_lab <- paste0(round(mean(abs(audience_price_differences$percentage_price_difference))), "%")
reach_diff_lab <- paste0(scales::number(round(mean(abs(audience_price_differences$reach_difference)))))
reach_max_lab <- paste0(scales::number(round(max(abs(audience_price_differences$reach_difference)))))
# print(price_diff_lab)
# print(perc_max_lab)
# print(perc_avg_lab)
# print(reach_diff_lab)
# print(reach_max_lab)

```


Political parties encounter significant differences in advertising costs depending on their audience targeting choices. On average, more specific targeting was observed to be more expensive compared to when we chose no targeting criteria. For example, ads targeting individuals with an interest in politics were, on average, `r perc_avg_lab` more expensive, while education-based targeting could increase costs by as much as `r perc_max_lab` in some countries.



```{r}
# Data for Audience Targeting Differences (Key Stats)
targeting_difference_data <- data.frame(
  Percentage = c(perc_avg_lab, perc_max_lab),
  Title = c("Average Targeting Price Increase", 
            "Maximum Targeting Price Increase"),
  Subtitle = c(glue::glue("On average, targeted ads cost {price_diff_lab} EUR more, with a price increase of {perc_avg_lab}. This results in a reduction of {reach_diff_lab} people on average."),
               glue::glue("The largest price increase observed was {perc_max_lab} when targeting people with below-university education, resulting in a reach reduction of {reach_max_lab} people.")),
  stringsAsFactors = FALSE
)

# Display Audience Targeting Percentage Section
shiny::HTML(percentage_section(targeting_difference_data))


```



### Party Differences

```{r}

# Calculate average price and reach for each party within each country
country_party_avg_prices <- ov %>%
  group_by(cntry, party) %>%
  summarize(avg_price = mean(price),
            avg_reach = mean(reach)) %>%
  arrange(cntry)

# Function to calculate price differences by party (only within the same country)
calculate_party_price_differences <- function(prices) {
  # Iterate over unique countries
  unique_countries <- unique(prices$cntry)
  
  results <- map_dfr(unique_countries, function(country) {
    # Filter for only the parties in the same country
    country_data <- prices %>% filter(cntry == country)
    
    # Get the number of parties in that country
    n <- nrow(country_data)
    
    if (n > 1) {
      # Generate all possible combinations of parties within the country
      party_combinations <- combn(seq_len(n), 2, simplify = FALSE)
      
      # Calculate the price differences for each pair of parties within the country
      map_dfr(party_combinations, function(pair) {
        idx1 <- pair[1]
        idx2 <- pair[2]
        
        party1 <- country_data$party[idx1]
        party2 <- country_data$party[idx2]
        
        price1 <- country_data$avg_price[idx1]
        price2 <- country_data$avg_price[idx2]
        price_diff <- price1 - price2
        
        reach1 <- country_data$avg_reach[idx1]
        reach2 <- country_data$avg_reach[idx2]
        reach_diff <- reach1 - reach2
        
        tibble(
          country = country,
          party1 = party1,
          party2 = party2,
          price_difference = price_diff,
          reach_difference = reach_diff,
          percentage_difference_original = (price_diff / price2) * 100,
          percentage_difference_lower = (price_diff / min(price1, price2)) * 100,
          percentage_difference_higher = (price_diff / max(price1, price2)) * 100,
      reach_diff_original = (reach_diff / reach2) * 100,
      reach_diff_lower = (reach_diff / min(reach1, reach2)) * 100,
      reach_diff_higher = (reach_diff / max(reach1, reach2)) * 100
        )
      })
    }
  })
  
  results %>% arrange(desc(abs(price_difference)))
}

# Calculate and display price differences by party within the same country
party_price_differences <- calculate_party_price_differences(country_party_avg_prices)

# View the results
# party_price_differences

```

```{r}

price_diff_lab <- glue::glue(paste0(round(mean(abs(party_price_differences$price_difference)), 2)))
perc_max_lab <- paste0(round(max(party_price_differences$percentage_difference_lower)), "%")
perc_avg_lab <- paste0(round(mean(abs(party_price_differences$percentage_difference_lower))), "%")
reach_diff_lab <- paste0(scales::number(round(mean(abs(party_price_differences$reach_difference)))))
reach_max_lab <- paste0(scales::number(round(max(abs(party_price_differences$reach_difference))))) 


scale_reach_difference <- function(initial_budget, initial_reach_diff, new_budget) {
  # Calculate the scaled reach difference
  scaled_reach_diff <- (initial_reach_diff * new_budget) / initial_budget
  
  # Round the result to the nearest whole number
  scaled_reach_diff <- round(scaled_reach_diff)
  
  # Return the result
  return(scaled_reach_diff)
}

# Example usage:
initial_budget <- 7
initial_reach_diff <- parse_number(str_remove(reach_diff_lab, " "))
new_budget <- 1000

# result <- scale_reach_difference(initial_budget, initial_reach_diff, new_budget)
# print(paste("Scaled reach difference:", result))
```


Within the same country, political parties face an average price variation of 4% for identical ads placed at the same time with the same budget, and for some parties this goes up to 11%. This creates an uneven playing field in national political landscapes, where some parties can reach significantly more voters than others with the same budget.

These price differences translate to substantial inequalities in potential voter reach. Assuming the prices scale, with a modest budget of €1000, parties reach an additional `r scales::number( scale_reach_difference(initial_budget, initial_reach_diff, new_budget))` voters  for the same price. The most favorably priced party in this study could reach an additional `r scales::number( scale_reach_difference(initial_budget, parse_number(str_remove(reach_max_lab, " ")), new_budget))` voters compared to the least favorably priced party. In a close election, this difference in voter outreach could prove decisive.


```{r}
shiny::HTML(percentage_section(data.frame(
  Percentage = c( perc_avg_lab, perc_max_lab),
  Title = c("Average Price Disparity Between Parties", 
            "Maximum Price Disparity Between Parties"),
  Subtitle = c(glue::glue("On average, prices between countries differ by {price_diff_lab} EUR or {perc_avg_lab}. This leads to a difference of {reach_diff_lab} people being reached on average."),
               glue::glue("Highest price vs. lowest (in Flanders). This leads to a difference of {reach_max_lab} people being reached between the two parties on average.")),
  stringsAsFactors = FALSE
)))
```




### Factors Affecting Ad Costs

**Account-Level Factors:** Political parties with more Facebook page likes paid higher prices for ads, though the correlation between page likes and ad pricing was weak (R = 0.084) and not statistically significant. 

*Political parties that historically spent more on ads in the past had to pay higher costs per thousand users compared to parties that spend less.* Correlations between ad spending and lower prices was moderately high (R values of 0.25 to 0.32). For every €10 000 a party has spent on ads historically, the cost to reach 1 000 new people increases by about 10 cents. This might not sound like much, but it can add up quickly for parties with large advertising budgets. To put this in perspective, if a party has already spent €100 000 on ads over time, they would be paying an extra €1 to reach voters compared to when they first started advertising.  However, it should be noted that this price difference is mainly driven by European political parties (which tend to spend less on average compared to national parties).

```{r}
# Data for Historic Ad Spend (Key Stats)
historic_spend_data <- data.frame(
  Percentage = c("€1"),
  Title = c("Cost Increase Per €100 000 Ad Spend"),
  Subtitle = c("For every €100 000 a political party spends on Facebook ads, the cost to reach users increases by €1 for 1000 users in future campaigns. This cumulative effect means larger advertisers may face progressively higher costs over time."),
  stringsAsFactors = FALSE
)

# Display Historic Ad Spend Percentage Section
shiny::HTML(percentage_section(historic_spend_data))
```


**Party-Level Factors - Voter Support:** There was a slight tendency for parties with greater electoral success to pay slightly lower ad prices, but this correlation (R = -0.14) was not statistically significant.

**Advertising Demand and Pricing:** Countries with higher total political ad spending tended to have lower ad prices overall (R = -0.34), however the relationship was not statistically significant. This means that greater competition for ad space did not necessarily lead to higher costs in all cases.

Countries with larger active Facebook user bases tended to see lower ad prices. The size of a country's audience correlated strongly with the price of ads (R = -0.63), indicating that in larger digital markets, political ads could be run at a lower cost.

### Demographic-Based Price Variations

```{r}


gender_names <- read_csv("data/gender.csv") %>% 
  janitor::clean_names()


gender_dat <- dir("data/reports", recursive = T, full.names = T) %>% 
  keep(~str_detect(.x, "\\bgender.csv\\b")) %>%
  discard(~str_detect(.x, "data/reports/gender.csv")) %>% 
  # discard(~str_detect(.x, "CDU|N")) %>% 
  map_dfr(~{
    # print(.x)
    if(str_detect(.x, "N-VA")){
      fin <- read_csv2(.x) %>% 
      set_names(names(gender_names)) %>% 
      mutate(path = .x)
    } else {
      fin <- read_csv(.x) %>% 
      set_names(names(gender_names)) %>% 
      mutate(path = .x)
    }
    return(fin %>% mutate_all(as.character))
    })  %>% 
  mutate(path = str_remove_all(path, "data/reports/|/overview.csv")) %>% 
  separate(path, into = c("cntry", "party"), sep = "/")   %>% 
  mutate(cost_per_result = fix_weird_numbers(cost_per_result)) %>% 
  mutate(cost_per_result = as.numeric(cost_per_result))   %>% 
  mutate(cost_per_result = case_when(
    cntry == "Denmark" ~ cost_per_result * 0.13,
    cntry == "Sweden" ~ cost_per_result * 0.09,
    cntry == "Hungary" ~ cost_per_result * 0.00253,
    T ~ cost_per_result
  )) %>% 
  filter(str_detect(campaign_name, "alt", negate = T)) %>% 
  mutate(iso2c = str_remove(campaign_name, " – Copy")) %>% 
  mutate(iso2c = str_remove(iso2c, "Research - ")) %>%
  mutate(starts = str_replace(starts, "29/04/2024", "2024-04-29")) %>% 
  mutate(starts = lubridate::ymd(starts)) %>% 
  mutate(ends = str_replace(ends, "6/05/2024", "2024-05-06")) %>% 
  mutate(ends = lubridate::ymd(ends)) %>% 
  mutate(number_of_days = as.numeric(ends-starts)) %>% 
  filter(number_of_days==7) %>%
  mutate(cntry = countrycode::countrycode(sourcevar = iso2c, origin = "iso2c", destination = "country.name")) %>% 
  mutate(cntry = case_when(
    party == "PS" ~ "Belgium-FR",
    party == "Les Engagés" ~ "Belgium-FR",
    party == "PTB" ~ "Belgium-FR",
    party == "Vooruit" ~ "Belgium-NL",
    party == "PVDA" ~ "Belgium-NL",
    party == "N-VA" ~ "Belgium-NL",
    party == "ALDE" & cntry == "Belgium" ~ "Belgium-NL",
    party == "ECPM" & cntry == "Belgium" ~ "Belgium-NL",
    T ~ cntry
  )) %>% 
  mutate(audience = str_remove(ad_name, " – Copy")) %>% 
  mutate(price = cost_per_result) %>% 
  mutate(page_id = case_when(
    party == "N-VA" ~ "334361224413",
    T ~ page_id
  ))



# Test the function
# test_data <- c("103.363.413", "101.002.004", "10.340.443", "2.52", "normal_entry")
# fixed_data <- fix_weird_numbers(test_data)
# print(fixed_data)


# saveRDS(gender_dat, file = "data/gender_dat.rds")
```


```{r}
# Calculate average price and reach for each gender within each country
country_gender_avg_prices <- gender_dat %>% 
  mutate(reach = as.numeric(reach)) %>% 
  group_by(cntry, gender) %>%
  summarize(avg_price = mean(price),
            avg_reach = mean(reach)) %>%
  arrange(cntry)

# Function to calculate price differences by gender (only within the same country)
calculate_gender_price_differences <- function(prices) {
  # Iterate over unique countries
  unique_countries <- unique(prices$cntry)
  
  results <- map_dfr(unique_countries, function(country) {
    # Filter for only the genders in the same country
    country_data <- prices %>% filter(cntry == country)
    
    # Get the number of genders in that country
    n <- nrow(country_data)
    
    if (n > 1) {
      # Generate all possible combinations of genders within the country
      gender_combinations <- combn(seq_len(n), 2, simplify = FALSE)
      
      # Calculate the price differences for each pair of genders within the country
      map_dfr(gender_combinations, function(pair) {
        idx1 <- pair[1]
        idx2 <- pair[2]
        
        gender1 <- country_data$gender[idx1]
        gender2 <- country_data$gender[idx2]
        
        price1 <- country_data$avg_price[idx1]
        price2 <- country_data$avg_price[idx2]
        price_diff <- price1 - price2
        
        reach1 <- country_data$avg_reach[idx1]
        reach2 <- country_data$avg_reach[idx2]
        reach_diff <- reach1 - reach2
        
        tibble(
          country = country,
          gender1 = gender1,
          gender2 = gender2,
          price_difference = price_diff,
          reach_difference = reach_diff,
          percentage_difference_original = (price_diff / price2) * 100,
          percentage_difference_lower = (price_diff / min(price1, price2)) * 100,
          percentage_difference_higher = (price_diff / max(price1, price2)) * 100,
          reach_diff_original = (reach_diff / reach2) * 100,
          reach_diff_lower = (reach_diff / min(reach1, reach2)) * 100,
          reach_diff_higher = (reach_diff / max(reach1, reach2)) * 100
        )
      })
    }
  })
  
  results %>% arrange(desc(abs(price_difference)))
}

# Calculate and display price differences by gender within the same country
gender_price_differences <- calculate_gender_price_differences(country_gender_avg_prices) %>% 
  filter(gender1 != "unknown") %>% 
  filter(gender2 != "unknown")

# Calculate summary statistics
price_diff_lab <- glue::glue(paste0(round(mean(abs(gender_price_differences$price_difference)), 2)))
perc_max_lab <- paste0(round(max(gender_price_differences$percentage_difference_lower)), "%")
perc_avg_lab <- paste0(round(mean(abs(gender_price_differences$percentage_difference_lower))), "%")
reach_diff_lab <- paste0(scales::number(round(mean(abs(gender_price_differences$reach_difference)))))
reach_max_lab <- paste0(scales::number(round(max(abs(gender_price_differences$reach_difference)))))

# # Display summary statistics
# print(paste("Average absolute price difference:", price_diff_lab))
# print(paste("Maximum percentage difference:", perc_max_lab))
# print(paste("Average absolute percentage difference:", perc_avg_lab))
# print(paste("Average absolute reach difference:", reach_diff_lab))
# print(paste("Maximum reach difference:", reach_max_lab))
```


**Age-Based Differences:** Targeting younger voters (ages 18-24) generally led to higher ad costs in some countries. In several instances, ads targeting younger demographics were more expensive than those targeting older groups, reflecting how ad algorithms value different segments of the electorate.


**Gender-Based Differences:** Ads targeting male audiences were often cheaper in several countries, including Belgium and Germany, while in other countries, the reverse was true. This suggests that the algorithms priced gender targeting differently depending on local market conditions.

```{r, eval = F}
# Data for Demographic-Based Price Variations (Key Stats)
demographic_difference_data <- data.frame(
  Percentage = c("Youth Targeting Costs More", "Gender-Based Pricing"),
  Title = c("Age-Based Price Differences", 
            "Gender-Based Price Differences"),
  Subtitle = c("Targeting younger voters (ages 18-24) generally led to higher ad costs in many countries, compared to targeting older demographics.",
               "In some countries, ads targeting male audiences were cheaper, while in others, ads targeting women had lower costs, depending on the local market."),
  stringsAsFactors = FALSE
)

# Display Demographic-Based Percentage Section
shiny::HTML(percentage_section(demographic_difference_data))
```


Our findings suggest that Facebook's ad delivery algorithms play a crucial role in shaping the digital political advertising landscape. These algorithms, while designed to optimize ad delivery, may inadvertently be influencing the democratic process in ways we're only beginning to understand.

# Introduction

Political advertising on social media platforms like Facebook has become a crucial tool for political parties to reach voters during election campaigns. Political parties and other advertisers may assume that the price of ads is relatively consistent across countries, audiences, and accounts, [but in reality, that is not the case](https://books.ipskampprinting.nl/thesis/635091-Votta/88/). Facebook uses an [auction-based system](https://www.facebook.com/business/help/430291176997542?id=561906377587030) where advertisers bid for the attention of users, and these bids are influenced by many factors, including local market conditions, user demand, and competition, but also many unknown and potential factors that we explore here. In this study, we aim to uncover why political parties across different countries are charged different prices for the same ads and what factors play a role in these pricing decisions.

By partnering with political parties throughout Europe, we have a unique opportunity to examine how algorithms tangibly affected the 2024 European elections. Our goal is to shed light on the variations in ad pricing and provide insights into Facebook's advertising cost structure. We investigate how different elements - including a party's past advertising expenditure, level of political backing, and even the gender of the reached audience - might influence ad prices. Our findings reveal an intriguing pattern: parties that have historically spent more on advertising often encounter escalating costs as time goes on. This creates what we might call a "spending tax," potentially putting political groups that invest heavily in certain markets at a disadvantage.

We also explore how these pricing dynamics vary not just between countries but within them, comparing costs for different political parties and demographic groups. This analysis reveals significant disparities that could have far-reaching implications for political discourse and campaign strategies across Europe. By understanding these pricing mechanisms, we can gain valuable insights into the evolving landscape of digital political advertising and its potential impact on democratic processes in the age of social media.



# Overview



In total we have data from **`r length(unique(overview$party))` parties** from **`r length(unique(overview$cntry))` regions/countries** (Flemish and Wallonian Belgium are counted separately).

Below an overview of the average prices paid and people reached, total spent, and start date (some campaigns didn't start on the same date as others).


```{r}
library(gt)
library(gtExtras)
# Define a color mapping for each country
country_colors <- c(
  "Germany" = "#F2D7D5",
  "France" = "#D5F2E3",
  "Spain" = "#E0D5F2"
)

overview %>%
  filter(cntry %in% c("Hungary", "Ireland", "Netherlands", "Sweden")) %>% 
  group_by(cntry, party) %>%
  summarize(
    price = mean(price),
    reach = mean(reach),
    amount_spent_eur = sum(amount_spent_eur),
    starts = starts[1]
  ) %>%
  ungroup() %>%
  arrange(cntry, desc(price)) %>%
  mutate(price = round(price, 2),
         reach = round(reach),
         amount_spent_eur = round(amount_spent_eur)) %>%
  set_names(c("Region", "Party", "€ per 1k", "Reach", "Total Spent", "Start")) %>%
  gt() %>%
  # Add background color for each country
  data_color(
    columns = vars(Region),
    colors = country_colors
  ) %>%
  # Highlight DIELINKE and CDU in grey
  tab_style(
    style = list(
      cell_fill(color = "grey")
    ),
    locations = cells_body(
      rows = Party %in% c("LINKE", "CDU", "Les Engagés", "Liberalerna", "DIEGRÜNEN")
    )
  ) %>%
  # Set a smaller font size for the table
  tab_options(
    table.font.size = px(8),
    table.width = pct(100)   # You can adjust the size as needed
  )  %>%
  # gt_plt_bar(
  #   column = `Reach`,  # Add bar charts to the price column
  #   scaled = F,  scale_type = "number",
  #   labels = TRUE, text_color = "black",           # Scale the bar charts relative to the values
  #   color = "lightblue"          # You can customize the bar color
  # ) %>%
  # Highlight the Start date for "Liberalerna" in red and bold
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "red")  # Red and bold text
    ),
    locations = cells_body(
      columns = vars(Start),  # Specify the Start column
      rows = Party %in% c("LINKE", "CDU", "DIEGRÜNEN", "Liberalerna")  # Apply style only to "Liberalerna"
    )
  ) %>%
  # Highlight the Start date for "Liberalerna" in red and bold
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "red")  # Red and bold text
    ),
    locations = cells_body(
      columns = `Total Spent`,  # Specify the Start column
      rows = Party %in% c("Les Engagés")
    )
  ) %>% 
  tab_header(
    title = md("**Table 1: Overview of Participating Parties**")
  )  %>% 
  gt::tab_footnote("Note: Parties that deviate from settings are shown in grey (red highlights the deviation). Those parties cannot be directly compared as they ran ads at different times / spend different budgets.")

```


```{r}


# Create the table
overview %>%
  filter(!(cntry %in% c("Hungary", "Ireland", "Netherlands", "Sweden"))) %>% 
  group_by(cntry, party) %>%
  summarize(
    price = mean(price),
    reach = mean(reach),
    amount_spent_eur = sum(amount_spent_eur),
    starts = starts[1]
  ) %>%
  ungroup() %>%
  arrange(cntry, desc(price)) %>%
  mutate(price = round(price, 2),
         reach = round(reach),
         amount_spent_eur = round(amount_spent_eur)) %>%
  set_names(c("Region", "Party", "€ per 1k", "Reach", "Total Spent", "Start")) %>%
  gt() %>%
  # Add background color for each country
  data_color(
    columns = vars(Region),
    colors = country_colors
  ) %>%
  # Highlight DIELINKE and CDU in grey
  tab_style(
    style = list(
      cell_fill(color = "grey")
    ),
    locations = cells_body(
      rows = Party %in% c("LINKE", "CDU", "Les Engagés", "Liberalerna", "DIEGRÜNEN")
    )
  ) %>%
  # Set a smaller font size for the table
  tab_options(
    table.font.size = px(8),
    table.width = pct(100)   # You can adjust the size as needed
  )  %>%
  # gt_plt_bar(
  #   column = `Reach`,  # Add bar charts to the price column
  #   scaled = F,  scale_type = "number",
  #   labels = TRUE, text_color = "black",           # Scale the bar charts relative to the values
  #   color = "lightblue"          # You can customize the bar color
  # ) %>%
  # Highlight the Start date for "Liberalerna" in red and bold
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "red")  # Red and bold text
    ),
    locations = cells_body(
      columns = vars(Start),  # Specify the Start column
      rows = Party %in% c("LINKE", "CDU", "DIEGRÜNEN")  # Apply style only to "Liberalerna"
    )
  ) %>%
  # Highlight the Start date for "Liberalerna" in red and bold
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "red")  # Red and bold text
    ),
    locations = cells_body(
      columns = `Total Spent`,  # Specify the Start column
      rows = Party %in% c("Les Engagés")
    )
  )  %>% 
  tab_header(
    title = md("**Table 1: Overview of Participating Parties (Continued)**")
  ) %>% 
  tab_footnote("Note: Parties that deviate from settings are shown in grey (red highlights the deviation). Those parties cannot be directly compared as they ran ads at different times / spend different budgets.")


  # DT::datatable(overview_tab)
```


Are you curious about how your party's ad pricing compares to others? We've created an [interactive dashboard](https://euroalgos.shinyapps.io/explore/) to help you explore these differences. 


## Research Questions and Hypotheses

Our research is guided by two main questions:

- **RQ1**: Do prices for political advertisements differ across countries and parties?

> For instance, if two parties from different countries run the same ad, will they be charged the same amount? And if two parties from the same country but with different levels of support run ads, will they face different costs?

- **RQ2**: What factors influence the price of political advertisements?

> Several factors could play a role in determining how much a party pays for ads. These factors include the number of followers the party has on Facebook, how much they have spent on ads in the past, and the overall demand for ad space during the election period. Below, we explore these factors in detail to understand their impact on ad pricing.


### Specific Research Questions

Several factors can influence the cost of political advertisements on Facebook. These include:

Account-Level Factors: This refers to characteristics of the Facebook account placing the ad. For example, parties with more followers or a higher history of ad spending tend to pay lower prices for their ads. This is because Facebook can more easily match these accounts with relevant audiences, reducing the cost of reaching each voter.

For instance, a party with 100,000 followers might pay less than a smaller party with only 5,000 followers because Facebook’s algorithm has more data to work with, making it easier to show the ad to the right people at a lower cost.

- **RQ2a**: Do account-level factors influence the price for political advertisements?

Party-Level Factors: The characteristics of a political party, such as its level of political support, can also impact ad prices. Parties with broad, mainstream support may pay less for their ads because their messages resonate with a larger audience, making it easier for Facebook to deliver the ad efficiently.

On the other hand, parties with niche or smaller voter bases may face higher prices because their target audience is more difficult to reach. For example, a party focused on environmental issues might have a harder time finding the right audience compared to a larger, more generalist party, leading to higher ad costs.

- **RQ2b**: Do party-level factors influence the price for political advertisements?

Market Context Factors: The overall advertising environment also plays a role. In countries where there is less competition for ad space, political advertisers may benefit from lower prices. Conversely, in countries with more competition, prices can rise sharply during election seasons, especially when many parties are vying for the same audience.

- **RQ2c**: Do market context factors influence the price for political advertisements?




# Results

In this section, we present a comprehensive analysis of our findings regarding ad pricing and reach across European countries during the 2024 European Parliament elections. Our analysis is structured to address our main research questions, followed by exploratory analyses to uncover potential drivers of price differences. 

## Descriptives

We begin by examining descriptive statistics that relate to our primary research question (RQ1): *Do prices for political advertisements differ across countries and parties?* These statistics provide an initial insight into the existence and magnitude of price differences by country and political party.




### Country Differences

In this section we explore differences in prices between countries and audiences. Using data obtained by the political parties, we can show that political parties in different countries running ads at the same time have considerably different costs for reaching the same amount of people.  Figure 1 illustrates the variation in the cost of reaching 1 000 users with political ads on Facebook across different European countries during the 2024 European Parliament elections.


```{r, fig.width=8, fig.height=6, dpi=300, fig.cap="The graph illustrates the variation in the cost of reaching 1 000 users with political ads on Facebook across different European countries during the 2024 European Parliament elections. The mean and standard deviation for each country are indicated above the respective points. Denmark exhibits the highest average price per 1 000 users (1.53 EUR), while Hungary has the lowest average price (0.36 EUR) -  an increase of 321.08%. On average, prices differ by 0.43 EUR or 76% between countries."}

library(EnvStats)

ov %>%
  group_by(cntry, party) %>%
  summarize(price = mean(price)) %>%
  ungroup() %>%
  mutate(cntry = fct_reorder(cntry, price)) %>%
  group_by(cntry) %>%
  mutate(mean_price = mean(price),
         sd_price = sd(price)) %>%  # Calculate the standard deviation for error bars
  ggplot(aes(cntry, price, color = cntry)) +
  geom_hline(yintercept = mean(ov$price, na.rm = TRUE), 
             linetype = "dashed", color = "black") +  # Add overall mean line
  # Add text label for "Overall Mean" along with its value
  geom_text(aes(x = Inf, y = mean(ov$price, na.rm = TRUE), 
                label = paste0("Overall Mean: ", sprintf("%.2f", mean(ov$price, na.rm = TRUE)))), 
            vjust = -0.5, hjust = 1.1, color = "black") +  # Add "Overall Mean" label and value
  geom_point(aes(y = mean_price)) +  # Plot mean price points
  geom_errorbar(aes(y = mean_price, ymin = mean_price - sd_price, 
                    ymax = mean_price + sd_price), 
                width = 0) +  # Add error bars based on standard deviation
  # Add mean value above the point with always two digits
  geom_text(aes(y = mean_price, label = paste0("Mean: ", sprintf("%.2f", mean_price))), 
            vjust = -1, size = 3, color = "black") +  # Show mean above the dot
  # Add standard deviation below the point with always two digits
  geom_text(aes(y = mean_price, label = paste0("SD: ", sprintf("%.2f", sd_price))), 
            vjust = 2, size = 3, color = "black") +  # Show SD below the dot
  ylim(0.3, 1.6) +  # Adjust y limits
  theme_minimal(base_size = 14) +
  labs(
    y = "Prices per 1k Users in Euro (per ad)",
    subtitle = "Takeaway: Prices differ between countries to a large degree",
    x = "",
    title = "Figure 1: Price Differences by Country"
  ) +
  coord_flip() +  # Flip coordinates for better readability
  ggthemes::scale_color_gdocs() +  # Use minimal theme
  theme(
    legend.position = "none"  # Remove legend
    # axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels
  )



```


To complement our understanding of pricing differences, we also examined variations in ad reach across countries. Figure 2 illustrates these differences.


```{r, fig.width=8, fig.height=6, dpi=300, fig.cap="The graph illustrates the variation in the reach of political ads on Facebook, measured by the number of unique users reached per ad across different European countries during the 2024 European Parliament elections. The mean and standard deviation for each country are indicated above and below the respective points. Hungarian political parties exhibit the highest average reach per ad (19,320 unique users), while Danish parties have the lowest average reach for the same price (4,472 unique users)."}


ov %>%
  group_by(cntry, party) %>%
  summarize(reach = mean(reach)) %>%
  ungroup() %>%
  mutate(cntry = fct_reorder(cntry, reach)) %>%
  group_by(cntry) %>%
  mutate(mean_reach = mean(reach),
         sd_reach = sd(reach)) %>%  # Calculate the standard deviation for error bars
  ggplot(aes(cntry, reach, color = cntry)) +
  geom_hline(yintercept = mean(ov$reach, na.rm = TRUE), 
             linetype = "dashed", color = "black") +  # Add overall mean line
  # Add text label for "Overall Mean" along with its value
  geom_text(aes(x = Inf, y = mean(ov$reach, na.rm = TRUE), 
                label = paste0("Overall Mean: ", sprintf("%.0f", mean(ov$reach, na.rm = TRUE)))), 
            vjust = -0.5, hjust = 1.1, color = "black") +  # Add "Overall Mean" label and value
  geom_point(aes(y = mean_reach)) +  # Plot mean reach points
  geom_errorbar(aes(y = mean_reach, ymin = mean_reach - sd_reach, 
                    ymax = mean_reach + sd_reach), 
                width = 0) +  # Add error bars based on standard deviation
  # Add mean value above the point with always two digits
  geom_text(aes(y = mean_reach, label = paste0("Mean: ", sprintf("%.0f", mean_reach))), 
            vjust = -1, size = 3, color = "black") +  # Show mean above the dot
  # Add standard deviation below the point with always two digits
  geom_text(aes(y = mean_reach, label = paste0("SD: ", sprintf("%.0f", sd_reach))), 
            vjust = 2, size = 3, color = "black") +  # Show SD below the dot
  # ylim(0.3, 1.6) +  # Adjust y limits
  theme_minimal(base_size = 14) +
  labs(
    y = "Reached Unique Users (per ad)",
    subtitle = "Takeaway: Reached people differs between countries to a large degree",
    x = "",
    title = "Figure 2: Reach Differences by Country"
  ) +
  coord_flip() +  # Flip coordinates for better readability
  ggthemes::scale_color_gdocs() +  # Use minimal theme
  theme(
    legend.position = "none"  # Remove legend
    # axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels
  )  +
  scale_y_continuous(labels = scales::number)



```




```{r, fig.width=10, fig.height=12, dpi=300, fig.cap="The graph illustrates the variation in the cost of reaching 1 000 users with political ads on Facebook across different European countries during the 2024 European Parliament elections. The price differences are shown for targeted audiences (below-university education level, people interested in politics) compared to the 'No Targeting' baseline. Audiences vary significantly in ad pricing. For example, Sweden shows a 11.8% increase for targeting people interested in politics and a 29.7% higher cost for targeting people with below-university level education."}


ov %>%
  filter(!is.na(price)) %>%
  group_by(cntry, audience) %>%
  summarize(mean_price = mean(price, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(cntry) %>%
  mutate(baseline_price = mean_price[audience == "No Targeting ad"]) %>%  
  mutate(perc_deviation = ifelse(audience != "No Targeting ad", 
                                 100 * (mean_price - baseline_price) / baseline_price, 
                                 0)) %>%
  ungroup() %>%
  mutate(
    Legend = case_when(
      perc_deviation > 0 ~ "More Costly Than No Targeting",
      perc_deviation < 0 ~ "Less Costly Than No Targeting",
      TRUE ~ "No Targeting ad (Baseline)"
    )
  ) %>%
  mutate(Legend = fct_relevel(Legend, c("More Costly Than No Targeting", "Less Costly Than No Targeting", "No Targeting ad (Baseline)"))) %>%
  # filter(audience != "No Targeting ad") %>%
  mutate(audience = case_when(
    audience == "Education ad" ~ "Below-University\nLevel Education",
    audience == "Politics ad" ~ "People Interested\nin Politics",
    T ~ "No Targeting"
  )) %>%
  mutate(audience = fct_relevel(audience, c("Below-University\nLevel Education", "People Interested\nin Politics", "No Targeting") %>% rev)) %>%

  ggplot(aes(x = audience, y = perc_deviation, color = Legend)) +
  geom_segment(aes(x = audience, xend = audience, y = 0, yend = perc_deviation), size = 1) +  # Lollipop sticks
  geom_point(size = 3, aes(shape = Legend)) +  # Lollipop heads
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  theme_minimal(base_size = 14) +
  geom_text(aes(label = paste0(sprintf("%.2f", perc_deviation), "%")), nudge_x = 0.25, size = 3) +  
  theme(strip.background = element_rect(fill = "lightgrey", color = NA)) +
  coord_flip() +
  facet_wrap(~cntry, scales = "free_y", ncol = 2) +
  scale_color_manual(values = c("blue", "red", "black")) +
  theme(legend.position = "bottom") +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +
  labs(
    x = "",    
    subtitle = "Takeaway: It is more costly to use targeting options as opposed to use no targeting",

    y = "\n⟵ Less Costly Than No Targeting | More Costly Than No Targeting ⟶",
    title = "Figure 3: Price Differences by Audience Compared to 'No Targeting'"
  )


```


### Party Differences

```{r, eval = F}
right_plot_data <- overview  %>%
  mutate(party = ifelse(party == "GroenLinks-PvdA", "GL-PvdA", party)) %>%
  
  # Step 1: Calculate price for each party
  group_by(cntry, party, audience) %>%
  summarize(price = mean(price)) %>%
  ungroup() 

saveRDS(right_plot_data, file = "data/right_plot_data.rds")
```



```{r, fig.width=12, fig.height=13, dpi=300,  fig.cap="Graph shows % deviations from the country average (dashed line at 0). For example, Vooruit's price is 15% higher than the Flemish average, while ALDE's is 9% lower. Grey triangles represent parties that are less comparable (due to timing / overall spending). They do not influence the country-level average presented in the graph.", eval = T}
library(patchwork)



# Data for the right-hand side countries
right_plot_data <- overview  %>%
  mutate(party = ifelse(party == "GroenLinks-PvdA", "GL-PvdA", party)) %>%
  
  # Step 1: Calculate price for each party
  group_by(cntry, party) %>%
  summarize(price = mean(price)) %>%
  ungroup() %>%
  

  
  # Step 2: Calculate country average excluding 'parties_had_to_excluded'
  group_by(cntry) %>%
  mutate(price_cntry_avg = mean(price[!party %in% parties_had_to_excluded])) %>%  # Country average excluding excluded parties
  # mutate(price_cntry_avg = mean(price)) %>%  # Country average excluding excluded parties
  
  # Step 3: Calculate price difference from the country average
  mutate(price = (price / price_cntry_avg - 1) * 100) %>%  # Price difference from country average in percentage
  ungroup() %>%
    # Step 5: Mutate for color and shapes
  mutate(
    Legend = case_when(
      party %in% parties_had_to_excluded ~ "Setting Differs (Timing/Spending)",
      price > 0 ~ "Higher Price on Average",
      price < 0 ~ "Lower Price on Average"
    )
  ) %>% 
  # Step 4: Reorder parties within each country based on price difference
  group_by(cntry) %>%
  mutate(party = reorder_within(party, price, cntry)) %>%
  ungroup() %>%
  mutate(Legend = fct_relevel(Legend, c("Higher Price on Average", "Lower Price on Average"))) %>%
  
  # Step 6: Assign custom label positions and colors
  mutate(cntry2 = ifelse(party %in% parties_had_to_excluded, NA, cntry)) %>%
  mutate(cntry3 = ifelse(party %in% parties_had_to_excluded, "exclude", "include"))

# saveRDS(right_plot_data, "data/right_plot_data.rds")
# Assign custom color and shape scales just once for both plots
color_scale <- scale_color_manual(values = c(
  "Higher Price on Average" = "blue", 
  "Lower Price on Average" = "red", 
  "Setting Differs (Timing/Spending)" = "grey"
))

# shape_scale <- scale_shape_manual(values = c(
#   "include" = 16, 
#   "exclude" = 17
# ))

# Right plot
right_plot <- ggplot(
  right_plot_data %>%
    filter(cntry %in% c("Belgium-FR", "Belgium-NL", "Denmark", "Germany", "Sweden")),
  aes(x = reorder_within(party, price, cntry), y = price, color = Legend, shape = Legend)
) +
  geom_segment(aes(xend = reorder_within(party, price, cntry), y = 0, yend = price), size = 1) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_text(aes(label = sprintf("%.2f%%", price)), nudge_x = 0.35, size = 3.25, show.legend = F) +
  coord_flip() +
  theme_minimal(base_size = 14) +
  facet_wrap(~ cntry, scales = "free_y", ncol = 1) +
  color_scale +  # Apply the color scale
  theme(
    legend.position = "bottom",
    strip.background = element_rect(fill = "lightgrey", color = NA),
    plot.margin = margin(5, 15, 5, 5)  # Increase right margin to 15
  ) +
  scale_shape_manual(values = c(16, 16, 17)) +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +  # Add percentage labels
  labs(x = "", y = "\n⟵  Price Lower Than Country Average | Price Higher Than Country Average ⟶") +
  scale_x_reordered()


# Left plot
left_plot <- ggplot(right_plot_data %>%
                      filter(!(
                        cntry %in% c("Belgium-FR", "Belgium-NL", "Denmark", "Germany", "Sweden")
                      )),
  aes(x = reorder_within(party, price, cntry), y = price, color = Legend, shape = Legend)
) +
  geom_segment(aes(xend = reorder_within(party, price, cntry), y = 0, yend = price), size = 1, show.legend = F) +
  geom_point(size = 2.15, show.legend = F) +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "black") +
  geom_text(aes(label = sprintf("%.2f%%", price)), nudge_x = 0.35, size = 3.25, show.legend = F) +
  coord_flip() +
  theme_minimal(base_size = 14) +
  facet_wrap( ~ cntry, scales = "free_y", ncol = 1) +
  color_scale +  # Apply the color scale
  # shape_scale +  # Apply the shape scale
  theme(
    legend.position = "none",
    strip.background = element_rect(fill = "lightgrey", color = NA),
    plot.margin = margin(5, 15, 5, 5)  # Increase right margin to 15
  ) +
  scale_shape_manual(values = c(16,16,17)) +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +  # Add percentage labels
  labs(x = "", y = "\n⟵  Price Lower Than Country Average | Price Higher Than Country Average ⟶") +
  scale_x_reordered()


# Combine both plots with patchwork and leave the 10th panel empty for the legend
(right_plot | left_plot) + 
  plot_layout(ncol = 2, heights = c(1, 0.5), guides = "collect", axis_titles = "collect") + 
  plot_annotation(title = "\t\tFigure 4: Variations in Ad Prices Across Parties",
                  subtitle = "\t\t\t\tTakeaway: Some parties pay higher prices than others for the same reach") &
  theme(plot.title = element_text(size = 21)) & 
  theme(legend.position = "bottom") & 
  guides(color = guide_legend(title = "Legend"))




```


<!-- In Figure 4, to ensure that our comparison is accurate, we exclude parties that used significantly different advertising settings, such as launching their campaigns later (e.g. LINKE, CDU), or spending substantially less in total (Lés Engagés). We have flagged these parties with grey triangles for transparency, but they do not influence the country-level average presented in the graph. -->


<!-- On average, the price disparity between parties *within* countries amounts to 3.47%, which corresponds to an average price difference of 0.04 EUR per 1k reached users. Given the prices we have set, this price difference results in reaching approximately 381 people on average. The maximum observed price disparity between parties is 26.98%, occurring in Flanders, where the highest prices (paid by Vooruit) and lowest ad prices (ALDE) differ substantially by 0.19 EUR per 1k reached users. Given the prices we have set, this difference allows ALDE to reach on average 2,096 more people compared to Vooruit. -->


## Exploratory analysis

Next, we explore account-level, party-level, and market-level factors.


### Account-Level Factors (RQ2a)

#### Number of Page Likes

```{r, fig.width=8, fig.height=6, dpi=300,  fig.cap="This scatter plot illustrates the relationship between the number of Facebook page likes and the standardized ad prices for various political parties across European countries during the 2024 European Parliament elections. The x-axis (logarithmic scale) represents the number of page likes, while the y-axis shows the standardized price of ads relative to each country's mean. Each point represents a political party, labeled with its name and country. The blue line indicates the linear regression trend. There is a weak positive correlation (R = 0.084, p = 0.6) between page likes and standardized ad prices, suggesting that parties with more followers tend to pay slightly higher prices relative to their country's average, though this relationship is not statistically significant."}

overview %>%
  group_by(party, iso2c) %>%
  summarize(page_likes = mean(page_likes, na.rm = T),
            price = mean(price)) %>%
  ungroup() %>%
  group_by(iso2c) %>% 
  mutate(price = scale(price)) %>% 
  ungroup() %>% 
  mutate(party = paste0(party, " (",iso2c, ")")) %>% 
  ggplot(aes(page_likes, price)) +
  # geom_jitter(width = 20000) +
  geom_point() +
  scale_x_log10(labels = scales::number) +
  geom_smooth(method = "lm", se = F) +
  ggpubr::stat_cor(label.y.npc = "top") +
  ggrepel::geom_text_repel(aes(label= party), max.overlaps = 2) +
  theme_minimal(base_size = 14) +
  labs(x = "Number of Facebook Page Likes (Log Scale)",   
       subtitle = "Takeaway: Page likes don't really influence pricing",

       y = "Standardized Ad Price (Deviations from Country Mean)",
       title = "Figure 5: Facebook Page Popularity on Political Ad Pricing")  
```




#### Historic Ad Spend


```{r, fig.width=9, fig.height=9, dpi=300,  fig.cap="This figure presents four scatter plots comparing political ad spending and standardized ad prices across various time frames for European political parties. Each plot shows ad spend (log scale) on the x-axis and standardized ad price (deviations from country mean) on the y-axis. A positive trend is observed in all four time periods, with R values ranging from 0.25 to 0.32, though the only statistically significant relationships are for the last 7 days (p = 0.043) and last 90 days (p = 0.038) of spending. Most importantly, this trend appears to be largely driven by European parties (represented by triangles), which tend to have lower ad spend and lower standardized prices. "}

library(ggplot2)
library(purrr)
library(ggpubr)
library(ggthemes)
library(ggrepel)

# Define the variables and titles for the plots
variables <- c("last7days_spend", "last30days_spend", "last90days_spend", "historic_spend")
titles <- c("A: Last 7 Days Spend", "B: Last 30 Days Spend", "C: Last 90 Days Spend", "D: Total Historic Spend")



plot_function <- function(var, title) {
  overview %>%
    group_by(party, iso2c, european) %>%
    summarize_at(vars(price, !!sym(var)), list(~mean(., na.rm = TRUE))) %>%
    ungroup() %>%
    group_by(iso2c) %>% 
    mutate(price = scale(price)) %>%
    ungroup() %>%
    mutate(party = paste0(party, " (",iso2c, ")")) %>% 
    mutate(spend := ifelse(!!sym(var) == 0, !!sym(var) + 1, !!sym(var))) %>% 
    mutate(the_facet = title)%>% 
    mutate(the_var = var)
}

map2_dfr(variables, titles, plot_function) %>%
    ggplot(aes_string(x = "spend", y = "price")) +
    geom_point(aes_string(color = "european", shape = "european")) +
    scale_x_log10(labels = scales::number) +
    geom_smooth(method = "lm", se = FALSE) +
    ggpubr::stat_cor(label.y.npc = "top") +
    ggrepel::geom_text_repel(aes(label = party), max.overlaps = 1) +
    theme_minimal(base_size = 14) +
    labs(x = "Ad Spend (Log Scale)", 
       subtitle = "Takeaway: Pages with more historic ad spend have higher prices",
         y = "Standardized Ad Price (Deviations from Country Mean)", 
       title = "Figure 6: Comparison of Political Ad Spending over Different Time Periods") +
  facet_wrap(~the_facet) +
    ggthemes::scale_color_colorblind() +
    scale_shape_manual(values = c(16, 17)) +
    theme(legend.position = "bottom", strip.background = element_rect(fil = "lightgrey", color = NA)) 
```



```{r, eval = F}

# Fit models
fit2 <- lmer(price ~ (1|audience) + (1|cntry), data = ov)

fit4 <- lmer(price ~ (1|audience) + (1|cntry) + log(page_likes/ 1000), data = ov)
fit5 <- lmer(price ~ (1|audience) + (1|cntry) + log(page_likes/ 1000) + last7days_spend2, 
             data = ov)
fit6 <- lmer(price ~ (1|audience) + (1|cntry) + log(page_likes/ 1000) + last30days_spend2, 
             data = ov)
fit7 <- lmer(price ~ (1|audience) + (1|cntry) + log(page_likes/ 1000) + last90days_spend2, 
             data = ov)
fit8 <- lmer(price ~ (1|audience) + (1|cntry) + log(page_likes/ 1000) + historic_spend2, 
             data = ov)
fit9 <- lmer(price ~ (1|audience) + (1|cntry) + log(page_likes/ 1000) + historic_spend2 + engagement , 
             data = ov)
# Display results
# huxtable::huxreg(fit4, fit5, fit6, fit7, fit8)
texreg::screenreg(list(fit2, fit4, fit5, fit6, fit7, fit8))
# texreg::htmlreg(list(fit2, fit4, fit5, fit6, fit7, fit8))

# anova(fit2, fit4, fit5)

```




### Party-Level Factors (RQ2b)


### Political support

```{r, eval=FALSE}
# https://results.elections.europa.eu/data-sheets/csv/2024-2029/election-results/results-parties/results-parties-be.csv
ress <- ov %>% distinct(iso2c) %>% pull(iso2c) %>%
  str_to_lower() %>% 
  str_remove_all("-nl|-fr") %>% 
  map_dfr(~{
    vroom::vroom(glue::glue("https://results.elections.europa.eu/data-sheets/csv/2024-2029/election-results/results-parties/results-parties-{.x}.csv")) %>% 
      mutate_all(as.character) %>% 
      mutate(iso2c = str_to_upper(.x))
  })

inte <- jsonlite::fromJSON("https://results.elections.europa.eu/data-sheets/json/2024-2029/election-results/parties.json")
# inte %>% View()

intes <- inte$countries %>% 
  pluck("candidates") %>% 
  bind_rows() %>% 
  janitor::clean_names() %>% 
  rename(party_id = candidate_id)

# Clean names and perform initial join
# Clean names and prepare ress data
cleaned_ress <- ress %>% 
  janitor::clean_names() %>% 
  left_join(intes) %>% 
  distinct(party_id, .keep_all = TRUE) %>% 
  rename(party = candidate_acronym) %>% 
  mutate(party = case_when(
    party == "Die Linke" ~ "LINKE",
    party == "CDU/CSU" ~ "CDU",
    party == "GRÜNE" ~ "Die Grünen",
    party == "ALT (Å)" ~ "Alternativet",
    party == "V" ~ "Venstre",
    party == "S (A)" ~ "Socialdemokratiet",
    party == "SF (F)" ~ "Socialistisk Folkeparti",
    party == "DF (O)" ~ "Dansk Folkeparti",
    party == "RV (B)" ~ "Radikale Venstre",
    party == "KF (C)" ~ "Konservative",
    party == "EL (Ø)" ~ "Enhedslisten",
    party == "LA (I)" ~ "Liberal Alliance",
    party == "LMP - Zöldek" ~ "LMP",
    party == "GP/CG" ~ "Greens",
    party == "Lab/LO" ~ "Labour",
    party == "GL - PvdA" ~ "GroenLinks-PvdA",
    party == "Miljöpartiet de gröna" ~ "Miljöpartiet",
    party == "M" ~ "Moderaterne",
    TRUE ~ party  # Catch any unmatched parties
  ))

saveRDS(cleaned_ress, "data/elex_results.rds")

# Perform left join from ov to cleaned_ress and find unmatched parties
unmatched_ov_parties <- ov %>% 
  distinct(party, iso2c, .keep_all = TRUE) %>% 
  select(party, iso2c, reach) %>% 
  left_join(cleaned_ress) %>% 
  filter(is.na(votes_percent)) %>% 
  distinct(party, iso2c)


# Display the unmatched parties
# print(unmatched_ov_parties)



# inte %>% 
#   # as_tibble() %>% 
#   # slice(1) %>% 
#   # select(countries) %>% 
#   unnest_wider(candidates)

# vroom::vroom(glue::glue("https://results.elections.europa.eu/data-sheets/csv/2024-2029/election-results/results-parties/results-parties-at.csv"))

# unmatched_ov_parties %>% 
#   group_by(cntry) %>% 
#   mutate(price = scale(price)) %>% 
#   ungroup() %>% 
#   mutate(votes_percent = as.numeric(votes_percent)) %>% 
#   ggplot(aes(votes_percent, price)) +
#   geom_point() +
#   geom_smooth(method  = "lm")

# Volt Germany - DE13
# DIEGRÜNEN Germany missing
# Volt Austria missing
# Konservative missing
# DK Hungary missing
# MZSP Hungary missing
# Párbeszéd Hungary missing
# Liberalerna missing
# Miljöpartiet missing
# Socialdemoraterna missing
```


```{r, fig.width=8, fig.height=6, dpi=300,  fig.cap="This graph shows the relationship between how well political parties performed in the 2024 European Parliament elections (measured as the percentage of votes won) and the standardized prices they paid for political ads. Each dot represents a political party, and the line shows the overall trend. The y-axis displays ad prices adjusted to show how much higher or lower they were compared to the average price in each country. The trend line shows a weak negative correlation (R = -0.14, p = 0.45), indicating that parties that received more votes tend to pay slightly lower prices for ads, though this relationship is not statistically significant and should therefore be interpreted with caution."}


cleaned_ress <- readRDS("data/elex_results.rds")

 overview %>% 
   group_by(iso2c, cntry, party) %>% 
   summarise(price = mean(price)) %>% 
   ungroup() %>% 
  # distinct(party, iso2c, .keep_all = TRUE) %>% 
  # select(party, iso2c, reach) %>% 
  left_join(cleaned_ress %>% 
              filter(party_id != "DE03") %>%  
              filter(party_id != "DE14") %>% 
              filter(party_id != "NL11")) %>% 
  mutate(party_id = case_when(
    party == "Volt" & cntry == "Germany" ~ "DE14",
    party == "DIEGRÜNEN" & cntry == "Germany" ~ "DE03",
    party == "Konservative" & cntry == "Denmark" ~ "DK06",
    party %in% c("DK", "MZSP", "Párbeszéd")  ~ "HU09",
    party %in% c("Liberalerna")  ~ "SE08",
    party %in% c("Miljöpartiet")  ~ "SE04",
    party %in% c("Socialdemoraterna")  ~ "SE01",
    T ~NA
  )) %>% 
  # drop_na(party_id) %>% 
  left_join(cleaned_ress %>% select(party_id, vp2 = votes_percent), by = "party_id") %>%
  mutate(votes_percent = ifelse(is.na(votes_percent), vp2, votes_percent)) %>% 
  # filter(is.na(votes_percent)) %>% 
  # select(party, party_id, votes_percent)
  group_by(cntry) %>% 
  mutate(price = scale(price)) %>% 
  ungroup() %>% 
  mutate(votes_percent = as.numeric(votes_percent)) %>% 
  mutate(votes_percent = case_when(
    party == "Volt" & iso2c == "AT" ~ 0,
    T ~ votes_percent
  )) %>% 
   
    mutate(party = paste0(party, " (",iso2c, ")")) %>% 
  ggplot(aes(votes_percent, price)) +
  geom_point() +
  geom_smooth(method  = "lm", se  = F) +
  ggrepel::geom_text_repel(aes(label = party), max.overlaps = 1) +
    scale_x_continuous(labels = scales::label_percent(scale = 1)) +  # Add percentage labels
  ggpubr::stat_cor(label.x.npc = "center") +
   theme_minimal()  +
  theme_minimal(base_size = 14) +
  labs(x = "\nNational Election Results in EP2024",       
       subtitle = "Takeaway: Electoral support does not influence ad pricing",

       y = "Standardized Ad Price (Deviations from Country Mean)\n",
       title = "Figure 7: Relationship Between Election Results and Ad Prices")
  
# cleaned_ress %>% select(party_id, votes_percent) %>% filter(party_id %in% c("DE14", "DE03", "DK06"))
```

<br>

<br>

### Market Context Factors (RQ2c)

#### Analysis of market conditions and ad demand

```{r, fig.width=8, fig.height=6, dpi=300, fig.cap="This scatter plot shows the relationship between the total amount spent on political ads in each country and the ad price. The x-axis represents the total amount spent on ads (in euros) over the past seven days for political purposes. The y-axis displays the average price for political ads (standardized within countries). Each point represents a country, and the blue line shows the overall trend. The correlation between spending and ad prices is moderate and negative, indicating that countries spending more tend to have slightly lower ad prices, however this correlation is not statistically significant. Source: Spending data from Meta Ad Library Report."}

ov %>%
  group_by(cntry) %>%
  summarize(last7days_total = mean(last7days_total, na.rm = T),
            price = mean(price)) %>%
  ungroup() %>%
  ggplot(aes(last7days_total, price)) +
  geom_jitter(aes(color = cntry), width = 20000) +
  geom_smooth(method = "lm", se = F) +
  ggpubr::stat_cor(label.y.npc = "top", label.x.npc = "center") +
  ggrepel::geom_text_repel(aes(label= cntry), max.overlaps = 2) +
  theme_minimal(base_size = 14) +
  labs(x = "\nTotal amount spent on political ads during study (in EUR)", 
       subtitle = "Takeaway: Total expenditure does not influence prices",
       title  = "Figure 8: Total Expenditure During Ad Experiment",
       y = "Price (standardized)\n") +
  theme(legend.position = "none") +
  ggthemes::scale_color_gdocs() +
  scale_x_continuous(labels = scales::number)
```



#### Impact of active user base on pricing



```{r}
age_gender_names <- read_csv("data/age_gender.csv") %>% 
  janitor::clean_names()


age_gender_dat <- dir("data/reports", recursive = T, full.names = T) %>% 
  keep(~str_detect(.x, "\\bage_gender.csv\\b")) %>%
  discard(~str_detect(.x, "data/reports/age_gender.csv")) %>% 
    # .[7] %>% 
  # discard(~str_detect(.x, "CDU|N")) %>% 
  map_dfr(~{
    # print(.x)
    if(str_detect(.x, "N-VA|SPÖ")){
      fin <- read_csv2(.x) %>% 
      set_names(names(age_gender_names)) %>% 
      mutate(path = .x)
    } else {
      fin <- read_csv(.x) %>% 
      set_names(names(age_gender_names)) %>% 
      mutate(path = .x)
    }
    return(fin %>% mutate_all(as.character))
    })  %>% 
  mutate(path = str_remove_all(path, "data/reports/|/age_gender.csv")) %>% 
  separate(path, into = c("cntry", "party"), sep = "/")   %>% 
  mutate(cost_per_result = fix_weird_numbers(cost_per_result)) %>% 
  mutate(cost_per_result = as.numeric(cost_per_result))   %>% 
  mutate(cost_per_result = case_when(
    cntry == "Denmark" ~ cost_per_result * 0.13,
    cntry == "Sweden" ~ cost_per_result * 0.09,
    cntry == "Hungary" ~ cost_per_result * 0.00253,
    T ~ cost_per_result
  )) %>% 
  filter(str_detect(campaign_name, "alt", negate = T)) %>% 
  mutate(iso2c = str_remove(campaign_name, " – Copy")) %>% 
  mutate(iso2c = str_remove(iso2c, "Research - ")) %>%
  mutate(starts = str_replace(starts, "29/04/2024", "2024-04-29")) %>% 
  mutate(starts = lubridate::ymd(starts)) %>% 
  mutate(ends = str_replace(ends, "6/05/2024", "2024-05-06")) %>% 
  mutate(ends = lubridate::ymd(ends)) %>% 
  mutate(number_of_days = as.numeric(ends-starts)) %>% 
  filter(number_of_days==7) %>%
  mutate(cntry = countrycode::countrycode(sourcevar = iso2c, origin = "iso2c", destination = "country.name")) %>% 
  mutate(cntry = case_when(
    party == "PS" ~ "Belgium-FR",
    party == "Les Engagés" ~ "Belgium-FR",
    party == "PTB" ~ "Belgium-FR",
    party == "Vooruit" ~ "Belgium-NL",
    party == "PVDA" ~ "Belgium-NL",
    party == "N-VA" ~ "Belgium-NL",
    party == "ALDE" & cntry == "Belgium" ~ "Belgium-NL",
    party == "ECPM" & cntry == "Belgium" ~ "Belgium-NL",
    T ~ cntry
  )) %>% 
  mutate(audience = str_remove(ad_name, " – Copy")) %>% 
  mutate(price = cost_per_result) %>% 
  mutate(page_id = case_when(
    party == "N-VA" ~ "334361224413",
    T ~ page_id
  ))
```


```{r}

eu_audiences <- readRDS("data/eu_audiences.rds")
# shiny::HTML(percentage_section(population_data))
 
tomerg_eu <- eu_audiences %>% 
  filter(region == "all" | region %in% c("Wallonische Region", "Flämische Region")) %>%
  filter(!(cntry == "BE" & region == "all")) %>% 
  filter(gender != "all")  %>% 
  filter(ages != "all") %>% 
  mutate(age = case_when(
    ages == "65" ~ paste0(ages, "+"),
    T ~ages
  )) %>% 
  mutate(cntry = countrycode::countrycode(sourcevar = cntry, origin = "iso2c", destination = "country.name")) %>% 
  mutate(cntry = case_when(
    str_detect(region, "Wallon") ~ "Belgium-FR",
    str_detect(region, "Fläm") ~ "Belgium-NL",
    T ~ cntry
  ))
```

```{r, fig.width=8, fig.height=6, dpi=300,  fig.cap="This scatter plot shows the relationship between the estimated number of active users (within 30 days before an ad was launched) and the price political parties paid for those ads. The x-axis (on a logarithmic scale) represents the lower bound of estimated active users segmented by country, target audience, age and gender. The y-axis displays the ad prices compared to the national average price (standardized). Each point represents a targeted ad, with the blue line showing the overall trend. There is a moderate negative correlation (R = -0.36, p < 0.001), indicating that as the active user base increases, the standardized ad prices tend to decrease."}

age_gender_dat %>% 
  mutate(condition = case_when(
    audience == "No Targeting ad" ~ "All",
    audience == "Education ad" ~ "Low Education",
    audience == "Politics ad" ~ "Politics",
  )) %>% 
  # count(cntry)
  select(cntry, party, condition, age, gender, price, contains("users_")) %>% 
  group_by(cntry, party, condition, age, gender) %>% 
  summarize(price = mean(price)) %>% 
  ungroup() %>% 
  # filter(party == "Die Grünen") %>% 
  left_join(tomerg_eu, by = c("cntry", "condition", "age", "gender")) %>% 
  filter(gender != "unknown") %>% 
  group_by(cntry) %>% 
  mutate(price = scale(price)) %>% 
  ungroup() %>% 
  ggplot(aes(users_lower_bound, price)) +
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  scale_x_log10() +
  theme_minimal(base_size = 14) +
  ggpubr::stat_cor() +
  labs(x = "Estimated Active Users in the Target Group (Log Scale)",
       subtitle = "Takeaway: Higher number of active users drives price down",
     y = "Ad Prices Compared to National Average (Standardized)",
     title = "Figure 9: Active User Base by Age, Gender, and Target Audience")

```
```{r, fig.width=8, fig.height=6, dpi=300,  fig.cap="This figure shows the relationship between the estimated number of active users in a target audience (in the 30 days before the ad campaign) and the ad prices paid by political parties. The x-axis (on a logarithmic scale) represents the estimated size of the target audience. The y-axis shows the standardized ad prices compared to the national average. Each point represents a specific ad campaign for a political party, and the blue line indicates the overall trend. A strong negative correlation (R = -0.63, p < 0.001) suggests that as the size of the target audience increases, the ad prices tend to decrease significantly."}

tomerg_ov <- eu_audiences %>% 
  filter(region == "all" | region %in% c("Wallonische Region", "Flämische Region")) %>%
  filter(!(cntry == "BE" & region == "all")) %>% 
  filter(gender == "all")  %>% 
  filter(ages == "all") %>% 
  mutate(age = case_when(
    ages == "65" ~ paste0(ages, "+"),
    T ~ages
  )) %>% 
  mutate(cntry = countrycode::countrycode(sourcevar = cntry, origin = "iso2c", destination = "country.name")) %>% 
  mutate(cntry = case_when(
    str_detect(region, "Wallon") ~ "Belgium-FR",
    str_detect(region, "Fläm") ~ "Belgium-NL",
    T ~ cntry
  ))


overview %>% 
  mutate(condition = case_when(
    audience == "No Targeting ad" ~ "All",
    audience == "Education ad" ~ "Low Education",
    audience == "Politics ad" ~ "Politics",
  )) %>% 
  # count(cntry)
  select(cntry, party, condition, price, contains("users_")) %>% 
  # filter(party == "Die Grünen") %>% 
  # filter(gender != "unknown") %>% 
  group_by(cntry, party, condition) %>% 
  summarize(price = mean(price)) %>% 
  ungroup() %>% 
  left_join(tomerg_ov, by = c("cntry", "condition")) %>% 
  group_by(cntry) %>% 
  mutate(price = scale(price)) %>% 
  ungroup() %>% 
  ggplot(aes(users_lower_bound, price)) +
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  scale_x_log10() +
  theme_minimal(base_size = 14) +
  ggpubr::stat_cor() +
  labs(x = "Estimated Active Users in Target Audience (Log Scale)",
       subtitle = "Takeaway: Higher number of active users drives price down",
     y = "Ad Prices Compared to National Average (Standardized)",
     title = "Figure 10: Active User Base Before Ad Campaign by Target Audience")

```


<br>


## Age

```{r}



age_names <- read_csv("data/age.csv") %>% 
  janitor::clean_names()


age_dat <- dir("data/reports", recursive = T, full.names = T) %>% 
  keep(~str_detect(.x, "\\bage.csv\\b")) %>%
  discard(~str_detect(.x, "data/reports/age.csv")) %>% 
  # discard(~str_detect(.x, "CDU|N")) %>% 
  map_dfr(~{
    # print(.x)
    if(str_detect(.x, "N-VA")){
      fin <- read_csv2(.x) %>% 
      set_names(names(age_names)) %>% 
      mutate(path = .x)
    } else {
      fin <- read_csv(.x) %>% 
      set_names(names(age_names)) %>% 
      mutate(path = .x)
    }
    return(fin %>% mutate_all(as.character))
    })  %>% 
  mutate(path = str_remove_all(path, "data/reports/|/overview.csv")) %>% 
  separate(path, into = c("cntry", "party"), sep = "/")   %>% 
  mutate(cost_per_result = fix_weird_numbers(cost_per_result)) %>% 
  mutate(cost_per_result = as.numeric(cost_per_result))   %>% 
  mutate(cost_per_result = case_when(
    cntry == "Denmark" ~ cost_per_result * 0.13,
    cntry == "Sweden" ~ cost_per_result * 0.09,
    cntry == "Hungary" ~ cost_per_result * 0.00253,
    T ~ cost_per_result
  )) %>% 
  filter(str_detect(campaign_name, "alt", negate = T)) %>% 
  mutate(iso2c = str_remove(campaign_name, " – Copy")) %>% 
  mutate(iso2c = str_remove(iso2c, "Research - ")) %>%
  mutate(starts = str_replace(starts, "29/04/2024", "2024-04-29")) %>% 
  mutate(starts = lubridate::ymd(starts)) %>% 
  mutate(ends = str_replace(ends, "6/05/2024", "2024-05-06")) %>% 
  mutate(ends = lubridate::ymd(ends)) %>% 
  mutate(number_of_days = as.numeric(ends-starts)) %>% 
  filter(number_of_days==7) %>%
  mutate(cntry = countrycode::countrycode(sourcevar = iso2c, origin = "iso2c", destination = "country.name")) %>% 
  mutate(cntry = case_when(
    party == "PS" ~ "Belgium-FR",
    party == "Les Engagés" ~ "Belgium-FR",
    party == "PTB" ~ "Belgium-FR",
    party == "Vooruit" ~ "Belgium-NL",
    party == "PVDA" ~ "Belgium-NL",
    party == "N-VA" ~ "Belgium-NL",
    party == "ALDE" & cntry == "Belgium" ~ "Belgium-NL",
    party == "ECPM" & cntry == "Belgium" ~ "Belgium-NL",
    T ~ cntry
  )) %>% 
  mutate(audience = str_remove(ad_name, " – Copy")) %>% 
  mutate(price = cost_per_result) %>% 
  mutate(page_id = case_when(
    party == "N-VA" ~ "334361224413",
    T ~ page_id
  ))


# saveRDS(age_dat, file = "data/age_dat.rds")
```


```{r, fig.width=12, fig.height=12, dpi = 300, fig.cap = "This graph shows the percentage difference in political ad prices when targeting younger audiences (18-24) compared to older audiences across various European parties. Positive values (blue) indicate that ads targeting younger audiences are more expensive, while negative values (red) show that ads for older audiences cost more. The dashed vertical line at 0 represents no age-based price difference. Grey triangles indicate parties that either ran ads at different times or had lower overall spending, making them less directly comparable."}

# Updated code using reorder_within and adjusting legend position
age_dat %>% 
  # filter(audience == "No Targeting ad") %>% 
  mutate(party = ifelse(party == "GroenLinks-PvdA", "GL-PvdA", party)) %>% 
  mutate(european = party %in% c("ALDE", "ECPM", "EGP")) %>% 
  filter(age != "unknown") %>% 
  mutate(reach = as.numeric(reach)) %>% 
  mutate(older = ifelse(age != "18-24", T, F)) %>% 
  mutate(older2 = ifelse(!(age %in% c("18-24", "25-34")), T, F)) %>% 
  mutate(younger = ifelse(age %in% c("18-24", "25-34"), T, F)) %>% 
  group_by(party, cntry) %>% 
  summarise(price_diff_pct = 100 * (price[age == "18-24"] - price[older]) / price[older]) %>%
  # summarise(price_diff_pct = 100 * (price[younger] - price[older2]) / price[older2]) %>%
  ungroup() %>% 
  group_by(party) %>% 
  mutate(price_diff_pct_ov = mean(price_diff_pct),
         price_diff_pct_sd = sd(price_diff_pct)) %>% 
  ungroup() %>% 
  group_by(party, cntry) %>%
  summarize(price_diff_pct = mean(price_diff_pct)) %>%
  mutate(
    Legend = case_when(
      party %in% parties_had_to_excluded ~ "Setting Differs (Timing/Spending)\nNot directly comparable",
      price_diff_pct >= 0 ~ "18-24 Year Olds Cost More",
      price_diff_pct < 0 ~ "25+ Year Olds Cost More"
    )
  ) %>% 
  mutate(Legend = fct_relevel(Legend, c("Men Cost More", "Women Cost More"))) %>% 
  group_by(cntry) %>%
  mutate(party = reorder_within(party, price_diff_pct, cntry)) %>%  # Sorting within country
  ungroup() %>% 
  ggplot(aes(party, price_diff_pct, color = Legend, shape = Legend)) +  # Add shape aesthetic
  geom_point(size = 2.15) +  # Adjust point size for visibility
  geom_segment(aes(y = 0, yend = price_diff_pct), size = 1) +  # Thicker lines for clarity
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  theme_minimal(base_size = 14) +
  geom_text(aes(label = sprintf("%.2f%%", price_diff_pct)), nudge_x = 0.35, size = 3.25) +  # Adjust text size
  theme(strip.background = element_rect(fill = "lightgrey", color = NA)) +
  coord_flip() +
  facet_wrap(~cntry, scales = "free_y", ncol = 2) +
  scale_color_manual(values = c( "blue", "red", "grey")) +
  scale_shape_manual(values = c(16,16,17)) +
  theme(legend.position = c(0.75, 0.07)) +
  scale_x_reordered() +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +  # Add percentage labels
  labs(
    x = "",       subtitle = "Takeaway: Younger audiences tend to be cheaper but not always",

    y = "\n⟵ Price Higher to Reach Older Audiences | Price Higher to Reach Younger Audiences ⟶",
    title = "Figure 11: Age-Based Price Differences by Party (in %)"
)
```



## Gender


```{r, eval = F}

region_names <- read_csv("data/region.csv") %>% 
  janitor::clean_names()


region_dat <- dir("data/reports", recursive = T, full.names = T) %>% 
  keep(~str_detect(.x, "\\bregion.csv\\b")) %>%
  discard(~str_detect(.x, "data/reports/region.csv")) %>% 
  # discard(~str_detect(.x, "CDU|N")) %>% 
  map_dfr(~{
    # print(.x)
    if(str_detect(.x, "N-VA")){
      fin <- read_csv2(.x) %>% 
      set_names(names(region_names)) %>% 
      mutate(path = .x)
    } else {
      fin <- read_csv(.x) %>% 
      set_names(names(region_names)) %>% 
      mutate(path = .x)
    }
    return(fin %>% mutate_all(as.character))
    })  %>% 
  mutate(path = str_remove_all(path, "data/reports/|/overview.csv")) %>% 
  separate(path, into = c("cntry", "party"), sep = "/")   %>% 
  mutate(cost_per_result = fix_weird_numbers(cost_per_result)) %>% 
  mutate(cost_per_result = as.numeric(cost_per_result))   %>% 
  mutate(cost_per_result = case_when(
    cntry == "Denmark" ~ cost_per_result * 0.13,
    cntry == "Sweden" ~ cost_per_result * 0.09,
    cntry == "Hungary" ~ cost_per_result * 0.00253,
    T ~ cost_per_result
  )) %>% 
  filter(str_detect(campaign_name, "alt", negate = T)) %>% 
  mutate(iso2c = str_remove(campaign_name, " – Copy")) %>% 
  mutate(iso2c = str_remove(iso2c, "Research - ")) %>%
  mutate(starts = str_replace(starts, "29/04/2024", "2024-04-29")) %>% 
  mutate(starts = lubridate::ymd(starts)) %>% 
  mutate(ends = str_replace(ends, "6/05/2024", "2024-05-06")) %>% 
  mutate(ends = lubridate::ymd(ends)) %>% 
  mutate(number_of_days = as.numeric(ends-starts)) %>% 
  filter(number_of_days==7) %>%
  mutate(cntry = countrycode::countrycode(sourcevar = iso2c, origin = "iso2c", destination = "country.name")) %>% 
  mutate(cntry = case_when(
    party == "PS" ~ "Belgium-FR",
    party == "Les Engagés" ~ "Belgium-FR",
    party == "PTB" ~ "Belgium-FR",
    party == "Vooruit" ~ "Belgium-NL",
    party == "PVDA" ~ "Belgium-NL",
    party == "N-VA" ~ "Belgium-NL",
    party == "ALDE" & cntry == "Belgium" ~ "Belgium-NL",
    party == "ECPM" & cntry == "Belgium" ~ "Belgium-NL",
    T ~ cntry
  )) %>% 
  mutate(audience = str_remove(ad_name, " – Copy")) %>% 
  mutate(price = cost_per_result) %>% 
  mutate(page_id = case_when(
    party == "N-VA" ~ "334361224413",
    T ~ page_id
  ))

saveRDS(region_dat, file = "data/region_dat.rds")

```



```{r, eval = F}
gender_reg <- gender_dat  %>% 
  select(ad_set_name, price, gender, party, cntry, audience) %>% 
  pivot_wider(names_from = gender, values_from = price, id_cols = c(ad_set_name, party, cntry, audience)) %>% 
  mutate(diff = male-female) %>% 
  filter(!(party %in% parties_had_to_excluded))

fit1 <- lmer(diff ~ (1|audience) + (1|cntry/party), data = gender_reg)

lm(diff ~ cntry + audience + party, data = gender_reg) %>% summary()
summary(fit1)
```


```{r, fig.width=12, fig.height=12, dpi = 300, fig.cap="Gender-based price differences for political ads across European parties. The graph shows the distribution of standardized price differences between male and female audiences for each party, grouped by country. Positive values (orange/yellow) indicate higher prices for male audiences, while negative values (purple/blue) indicate higher prices for female audiences. The dashed vertical line represents no gender difference in pricing. Parties are ordered by their average price difference, with those at the top showing the largest male-female price disparities.", eval  = F}

summ_dat <- gender_dat  %>% 
  mutate(european = party %in% c("ALDE", "ECPM", "EGP"))   %>% 
  filter(!(party %in% parties_had_to_excluded)) %>%  
  # filter(!european) %>% 
  filter(gender != "unknown") %>% 
  # filter(audience == "No Targeting ad") %>%
  # filter(party == "FDP")
  group_by(audience, party, cntry) %>% 
  summarise(price_idff = price[gender == "male"] - price[gender == "female"]) %>%
  ungroup() %>% 
  # group_by(cntry) %>%
  # mutate(price_idff = scale(price_idff)) %>%
  # ungroup() %>%
  # filter(audience == "No Targeting ad") %>%
  # filter(cntry == "Belgium-NL") %>% 
  mutate(party = paste0(party, " (",cntry, ")")) %>% 
  group_by(party) %>% 
  mutate(price_idff_ov = mean(price_idff),
         price_idff_sd = sd(price_idff)) %>% 
  ungroup() %>% 
  group_by(party) %>% 
  summarize(price_idff = mean(price_idff)) %>% 
  mutate(party = fct_reorder(party, price_idff))

gender_dat  %>% 
  mutate(european = party %in% c("ALDE", "ECPM", "EGP"))   %>% 
  filter(!(party %in% parties_had_to_excluded)) %>%  
  # filter(!european) %>% 
  filter(gender != "unknown") %>% 
  # filter(audience == "No Targeting ad") %>%
  # filter(party == "FDP")
  group_by(audience, party, cntry) %>% 
  summarise(price_idff = price[gender == "male"] - price[gender == "female"]) %>%
  ungroup() %>% 
  # group_by(cntry) %>%
  # mutate(price_idff = scale(price_idff)) %>%
  # ungroup() %>%
  # filter(audience == "No Targeting ad") %>%
  # filter(cntry == "Belgium-NL") %>% 
  mutate(party = paste0(party, " (",cntry, ")")) %>% 
  group_by(party) %>% 
  mutate(price_idff_ov = mean(price_idff),
         price_idff_sd = sd(price_idff)) %>% 
  ungroup() %>% 
  mutate(party = fct_reorder(party, price_idff)) %>% 
  ggplot(aes(price_idff, party, fill = stat(x))) +
  ggridges::geom_density_ridges_gradient(color = "black", scale = 2, rel_min_height = 0.01) +
  scale_fill_viridis_b(name = "Temp. [F]", option = "C") +
  # geom_point(alpha = 0.5) +
  geom_vline(xintercept = 0,
             linetype = "dashed", color = "black") +
  ggridges::theme_ridges() +
  # xlim(-3, 3) +
  # Add overall mean line
  # geom_point(aes(y = price_idff_ov), color = "red") +
  # geom_errorbar(aes(ymin = price_idff_ov-price_idff_sd, ymax = price_idff_ov+price_idff_sd), color = "red") +
  # coord_flip()  +
  geom_point(data = summ_dat, aes(price_idff, party)) +
  geom_segment(data = summ_dat, aes(x = 0, xend = price_idff))
  # facet_wrap(~audience, scales = "free_x")
```



```{r, fig.width=12, fig.height=12, dpi = 300, fig.cap = "Percentage differences in political ad pricing by gender across European parties. The graph displays how much more or less political ads cost when targeting male compared to female audiences, grouped by country. Negative values (red) indicate that ads for male audiences are cheaper, while positive values (blue) indicate higher prices for male audiences. The dashed vertical line at 0 represents no gender-based pricing difference. The grey triangles are parties that ran ads later (e.g. LINKE, CDU) or spend less money overall (Les Engagés) and are therefore not directly comparable."}


# Updated code using reorder_within and adjusting legend position
gender_dat %>% 
  # filter(audience == "No Targeting ad") %>% 
  mutate(party = ifelse(party == "GroenLinks-PvdA", "GL-PvdA", party)) %>% 
  mutate(european = party %in% c("ALDE", "ECPM", "EGP")) %>% 
  filter(gender != "unknown") %>% 
  mutate(reach = as.numeric(reach)) %>% 
  group_by(party, cntry) %>% 
  summarise(price_diff_pct = 100 * (price[gender == "male"] - price[gender == "female"]) / price[gender == "female"]) %>%
  ungroup() %>% 
  group_by(party) %>% 
  mutate(price_diff_pct_ov = mean(price_diff_pct),
         price_diff_pct_sd = sd(price_diff_pct)) %>% 
  ungroup() %>% 
  group_by(party, cntry) %>%
  summarize(price_diff_pct = mean(price_diff_pct)) %>%
  mutate(
    Legend = case_when(
      party %in% parties_had_to_excluded ~ "Setting Differs (Timing/Spending)\nNot directly comparable",
      price_diff_pct >= 0 ~ "Men Cost More",
      price_diff_pct < 0 ~ "Women Cost More"
    )
  ) %>% 
  mutate(Legend = fct_relevel(Legend, c("Men Cost More", "Women Cost More"))) %>% 
  group_by(cntry) %>%
  mutate(party = reorder_within(party, price_diff_pct, cntry)) %>%  # Sorting within country
  ungroup() %>% 
  ggplot(aes(party, price_diff_pct, color = Legend, shape = Legend)) +  # Add shape aesthetic
  geom_point(size = 2.15) +  # Adjust point size for visibility
  geom_segment(aes(y = 0, yend = price_diff_pct), size = 1) +  # Thicker lines for clarity
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  theme_minimal(base_size = 14) +
  geom_text(aes(label = sprintf("%.2f%%", price_diff_pct)), nudge_x = 0.35, size = 3.25) +  # Adjust text size
  theme(strip.background = element_rect(fill = "lightgrey", color = NA)) +
  coord_flip() +
  facet_wrap(~cntry, scales = "free_y", ncol = 2) +
  scale_color_manual(values = c( "blue", "red", "grey")) +
  scale_shape_manual(values = c(16,16,17)) +
  theme(legend.position = c(0.75, 0.07)) +
  scale_x_reordered() +
  scale_y_continuous(labels = scales::label_percent(scale = 1)) +  # Add percentage labels
  labs(
    x = "x",
    x = "",       subtitle = "Takeaway: Gender pricing depends on the country",
       y = "\n⟵ Price Higher to Reach Women | Price Higher to Reach Men ⟶",
    title = "Figure 12: Gender-Based Price Differences by Party (in %)"
)


```


```{r}
library(lme4)
fit1 <- lmer(price ~ (1|audience) + gender, data = gender_dat %>% filter(gender != "unknown"))
fit2 <- lmer(price ~ (1|audience) + (1|cntry) + gender, data = gender_dat%>% filter(gender != "unknown"))
fit3 <- lmer(price ~ (1|audience) + (1|cntry) + gender*party, data = gender_dat%>% filter(gender != "unknown"))
          
```

```{r, fig.height=12, eval = F}
anova(fit1,fit2,fit3)
summary(fit3)

sjPlot::plot_model(fit3, show.p = T, show.values = T)


```


```{r, eval = F}

library(parameters)
library(modelbased)

contrasts_nobreak_h1abcde <- estimate_contrasts(fit3, contrast = c( "party", "gender"),
                                at = c("party", "gender")) %>% 
  as.data.frame()  %>%  
  mutate(Contrast = paste(Level1, "-", Level2)) %>%  
  mutate(condition_comparison = fct_reorder(Contrast, Difference)) 

share_gg_dat <- contrasts_nobreak_h1abcde %>% 
  as_tibble()  %>% 
  filter(
    str_count(condition_comparison, "VVD") == 2 |
    str_count(condition_comparison, "GroenLinks") == 2 |
    str_count(condition_comparison, "PvdA") == 2 
  ) %>% 
  # filter(str_detect(Level1, "Environment excluded") & !str_detect(Level2, "Environment excluded")) %>% 
  filter(
    str_count(condition_comparison, "Environment") == 2 |
    str_count(condition_comparison, "Economy") == 2 |
    str_count(condition_comparison, "Politics") == 2 |
    str_count(condition_comparison, "Education") == 2 
  ) %>% 

  # in case the comparison is in wrong direction, change around
  mutate_at(vars(Difference, CI_low, CI_high), ~ifelse(str_detect(Level1, "excluded"), .x*-1, .x)) %>%
  mutate_at(vars(Difference, CI_low, CI_high), ~ifelse(str_detect(Level1, "Low"), .x*-1, .x)) %>%
  mutate(plabel = get_plabs(p)) %>% 
  mutate(diff_label = paste0(format(round(Difference, 2)), plabel)) %>%
  mutate(party = str_extract(condition_comparison, "VVD|GroenLinks|PvdA")) %>% 
  mutate(condition_comparison = str_remove_all(condition_comparison, "VVD|GroenLinks|PvdA")) %>% 
  mutate(condition_comparison = case_when(
    str_detect(condition_comparison, "Economy") ~ "Economy (vs. not)",
    str_detect(condition_comparison, "Education") ~ "Higher Educated (vs. lower)",
    str_detect(condition_comparison, "Politics") ~ "Politics (vs. not)",
    str_detect(condition_comparison, "Environment") ~ "Environment (vs. not)"
    )) %>% 
  # mutate(condition_comparison = fct_reorder(condition_comparison, Difference)) %>% 
  mutate(condition_comparison = fct_relevel(condition_comparison, c("Higher Educated (vs. lower)", "Politics (vs. not)", "Economy (vs. not)", "Environment (vs. not)") %>% rev)) %>% 
  mutate(facet_title = "B: Differences in share of ad delivery per party") 

share_gg <- share_gg_dat %>% 
  ggplot(aes(condition_comparison, Difference, color = party)) + 
  geom_point(position = position_dodge(width = 0.9)) +
  geom_errorbar(aes(ymin = CI_low, ymax = CI_high), width = 0) +
  # geom_text(aes(label = diff_label, y = Difference , x = c(0.8, 1.05, 1.4)), show.legend = F) +
  coord_flip() +
  geom_text(aes(label = diff_label, x = as.factor(condition_comparison) %>% as.numeric() %>% magrittr::add(0.1)), show.legend = F) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(y = "Estimated ad delivery differences (in %)",
       x = "") +
  theme_minimal() +
  scale_color_parties() +
  # facet_grid(condition_comparison ~ ., scales= "free_y" ) +
  # facet_wrap(~condition_comparison, ncol = 1, scales= "free_y" ) +
  facet_wrap(~facet_title) +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 19, face = "bold"),
        strip.text.y = element_blank(), 
        axis.text.y =  element_blank(), 
        strip.background = element_rect(fill = "lightgrey", color = NA))   +
  # ggtitle("B: Differences in share of ad delivery per party") +
  geom_vline(xintercept = 1.55, color = "lightgrey", alpha = 0.75, linetype = "dashed")+
  geom_vline(xintercept = 2.55, color = "lightgrey", alpha = 0.75, linetype = "dashed")+
  geom_vline(xintercept = 3.55, color = "lightgrey", alpha = 0.75, linetype = "dashed")


contrasts_nobreak_h1abcde
```

```{r, eval = F}
library(lme4)
library(emmeans)

# Fit the model
fit3 <- lmer(price ~ (1|audience) + (1|cntry) + gender*party, 
             data = gender_dat %>% filter(gender != "unknown"))

# Summary of the model to check interaction terms
summary(fit3)

# Post-hoc pairwise comparison using emmeans
emmeans_fit <- emmeans(fit3, ~ gender | party)
pairwise_contrasts <- contrast(emmeans_fit, method = "pairwise", adjust = "tukey")

# View pairwise comparisons and significance
pairwise_contrasts %>% 
  as_tibble() %>% 
  arrange(desc(p.value))

```


# Conclusions

Our study reveals significant disparities in the pricing of political advertisements on Facebook across different countries and parties during the 2024 European Parliament elections. These disparities have implications for democratic processes, as they may influence the reach and effectiveness of political campaigns.

Key findings include:

+ Significant price differences exist across countries, with up to a 321% variance between the highest and lowest average prices.
+ Within countries, parties experience price variations that can impact their potential voter reach significantly.
+ Factors such as the number of page likes and historical ad spending show some correlation with ad pricing but are not solely determinative.
+ Facebook's ad delivery algorithms, while optimized for efficiency, may inadvertently create inequalities in the political advertising landscape.


# Recommendations

+ Transparency: Social media platforms should provide greater transparency regarding their ad pricing algorithms to ensure a fair playing field for all political parties.

+ Regulation: Policymakers may consider regulations that address algorithmic biases in political advertising to protect democratic processes.

+ Further Research: Additional studies should be conducted to explore the impact of other factors, such as ad content and user engagement metrics, on ad pricing.




# Methodology


We conducted an **algorithm audit study** where we asked political parties across multiple European countries to run identical political ads on Facebook. These ads were designed to be non-partisan and simply encouraged people to vote. 


Our approach to selecting participants was designed to capture a broad, representative picture of the European political landscape. We cast a wide net, inviting national parties represented in their country's parliament, parties with seats in the European Parliament, and European parties (e.g. European Greens). We also sought to include parties across the political spectrum. From established mainstream parties to newer, emerging political movements, we wanted our sample to reflect the full range of political voices competing for attention in the European political arena. In the end, we secured participation from `r length(unique(overview$party))` political parties across `r length(unique(overview$cntry))` countries/regions.

By using the same ad text, images, and budgets for each party, we aimed to ensure that the only differences in pricing would be due to the factors we were studying—such as the country, the party's characteristics, or the audience being targeted.

The ads were placed in three different conditions:

1. **Interest in Politics**: Ads targeted at people who had expressed interest in politics.
2. **Below-University Education**: Ads targeted at people with below university-levels of education.
3. **No Targeting**: Ads were shown to a random, general audience without any specific targeting.

We collected data on how much each party paid to reach 1,000 users (this is called CPM, or Cost Per Thousand impressions) and analyzed how these prices varied across the three conditions.


- **Daily Budget**: €1 per ad
- **Campaign Duration**: 7 days
- **Number of Ads**: 5 ad copies per target audience, across 3 audiences
- **Total Investment**: €105 per national actor, 5x for European actors

Each political party runs one ad campaign with several ad sets, each containing a single ad. This setup ensures that individual ads from the same party and targeting the same audience do not compete against each other. All ads are placed simultaneously, with the same budget, targeting the same audiences to control for temporal heterogeneity.


## Sample Reduction

In the following we will only continue to work with parties that meet the following conditions.

1. ads must have started at the same time (starting April 29th)
2. ads must have run for 7 days
3. total spent must have been within same range (i.e. +- 5 Euro)


```{r}
 # overview %>% 
 #  filter(starts == as.Date("2024-04-29"))  %>% 
 #  filter(party == "Les Engagés")
```


This leaves us with **`r length(unique(ov$party))` parties** from **`r length(unique(overview$cntry))` regions/countries**.





We are exploring two main hypotheses related to the pricing of political advertisements on Facebook across different countries and political parties. These hypotheses test whether political parties experience different costs when running ads, even when targeting the same audiences with the same advertisements.

The first hypothesis focuses on *whether political ad pricing varies depen on the country* where the ads are being placed. 

1. **H1**: The price for political advertisements differs across countries.


We expect to observe significant price disparities between countries, with some paying much more for the same audience reach than others. This could be due to a combination of factors such as the number of advertisers, the overall demand for Facebook ads, and the size of the potential audience in each country.





The second hypothesis examines *whether different political parties are charged different prices* for running the same ad, even within the same country.

2. **H2**: Political parties are charged different prices for running the same political advertisements.


One possible reason for this is Facebook’s ad delivery algorithm, which takes into account not only the content of the ad but also the advertiser’s account characteristics. Parties with more followers or those who have spent more money on ads in the past may be seen as more valuable customers, and thus Facebook may offer them lower prices as a way to encourage more spending. On the other hand, smaller parties or those with less digital presence might be charged more because Facebook has less data about them, making it harder to target their ads efficiently.



In the following sections, we will formally test our hypotheses regarding these observed differences and explore potential factors driving these variations in ad pricing and reach across European countries.

## Hypothesis Testing

Our approach to analyzing all this data combined rigorous statistical testing with exploratory data analysis. Next, we test our two main hypotheses:

To see if ad prices really do vary across countries (H1), we use a so-called a likelihood ratio test. We compare two statistical models: one that didn't take country into account at all, and one that did. If the model that included country as a factor fit our data significantly better, that would tell us that country really does matter when it comes to ad pricing.

We use the same approach to test whether prices vary between parties (H2). We compared a model that only looked at countries to one that also included individual parties. Again, if including parties in the model made it fit our data better, that would suggest that different parties really do pay different prices for the same ads.

We used multilevel modeling for these tests. This is a statistical technique that's well-suited for data like ours, where we have ads nested within parties, which are in turn nested within countries.

Beyond just testing whether these differences exist, we also wanted to know how big they are. So we estimated the size of the effects that countries and parties have on ad pricing. This helps us understand not just whether these factors matter, but how much they matter.

### Price Variance Across Countries (H1)

```{r,eval = F}
ov %>% 
  group_by(cntry) %>% 
  summarize(price = mean(price)) %>% 
  mutate(sddd = sd(price))

ov %>% summarize(price = mean(price))

```

```{r,eval = F}
0.9712084 / 0.3574499
```

```{r,eval = F}
# Calculate Coefficient of Variation for all ads
cv_all_ads <- sd(ov$price) / mean(ov$price) * 100

# Print result
cat("Coefficient of Variation across all ads:", round(cv_all_ads, 2), "%\n")

# You could also calculate it by country
cv_by_country <- ov %>%
  group_by(cntry, audience) %>%
  summarize(cv = sd(price) / mean(price) * 100) %>% 
  group_by(cntry) %>% 
  summarize(cv = mean(cv))

print(cv_by_country)

mean(cv_by_country$cv)
```



We used a likelihood ratio test to compare a base model (without country variable) against a model with a random intercept for each country. The test determines whether including countries significantly increases the model's likelihood given the data.

The ANOVA results comparing the two models show a significant improvement when including the country variable (p < 0.001), indicating that ad prices differ by country. The random intercept for country has a standard deviation of 0.357.

This suggests that the country a political ad is placed in can substantially influence the cost, with prices varying by up to 36 Euro cents/1k users around the overall mean.

```{r, results='asis', echo = F}

library(flextable)
fit0 <- lmer(price ~ (1|cntry), data = ov)

fit1 <- lmer(price ~ (1|audience), data = ov)
fit2 <- lmer(price ~ (1|audience) + (1|cntry), data = ov)
fit3 <- lmer(price ~ (1|audience) + (1|cntry/party), data = ov)


# Run ANOVAs 
anova1 <- anova(fit1, fit2)
anova2 <- anova(fit2, fit3)

anova_text <- function(anova_result, mod1, mod2) {
  # Extract relevant ANOVA information (Chi-sq statistic and p-value)
  anova_chisq <- round(anova_result$Chisq[2], 2)
  anova_pvalue <- format.pval(anova_result$`Pr(>Chisq)`[2], digits = 2, eps = 0.0001)
  
  paste0("LRT between Model ",mod1," and Model ",mod2,": Chi-sq = ", anova_chisq, 
                          ", p-value = ", anova_pvalue)
}


# Extract estimates and standard errors from both fit1 and fit2
tidy_fit1 <- broom.mixed::tidy(fit1)
tidy_fit2 <- broom.mixed::tidy(fit2)
tidy_fit3 <- broom.mixed::tidy(fit3)

# Create a combined data frame with estimates and standard errors from both models
combined_df <- tidy_fit1 %>%
  select(term, group, estimate = estimate, std.error = std.error) %>%
  rename(Estimate_Model_1 = estimate, SE_Model_1 = std.error) %>%
  full_join(
    tidy_fit2 %>%
      select(term, group, estimate = estimate, std.error = std.error) %>%
      rename(Estimate_Model_2 = estimate, SE_Model_2 = std.error)
  ) %>%
  full_join(
    tidy_fit3 %>%
      select(term, group, estimate = estimate, std.error = std.error) %>%
      rename(Estimate_Model_3 = estimate, SE_Model_3 = std.error)
  ) %>% 
  mutate(
    Model_1 = ifelse(
      is.na(Estimate_Model_1), "", 
      sprintf("%.3f%s", Estimate_Model_1, ifelse(is.na(SE_Model_1), "", sprintf(" (%.3f)", SE_Model_1)))
    ),
    Model_2 = ifelse(
      is.na(Estimate_Model_2), "", 
      sprintf("%.3f%s", Estimate_Model_2, ifelse(is.na(SE_Model_2), "", sprintf(" (%.3f)", SE_Model_2)))
    ),
    Model_3 = ifelse(
      is.na(Estimate_Model_3), "", 
      sprintf("%.3f%s", Estimate_Model_3, ifelse(is.na(SE_Model_3), "", sprintf(" (%.3f)", SE_Model_3)))
    )
  )  %>% 
  mutate(term = ifelse(term == "sd__(Intercept)" & group == "audience", "sd__(audience)", term)) %>%
  mutate(term = ifelse(term == "sd__(Intercept)" & group == "party:cntry", "sd__(party)", term)) %>%
  select(term,  Model_1, Model_2, Model_3)

# Create the flextable
happens <- flextable(combined_df) %>%
  set_header_labels(
    term = "Coefficients",
    Model_1 = "Baseline: Only Target Audience - Model 1 ",
    Model_2 = "Country and Target Audience - Model 2 ",
    Model_3 = "Country, Target Audience, and Party - Model 3 "
  ) %>%
  
  # Add a title to the table
  set_caption("Table 2: Ad Price Variation by Country, Target Audience, and Party") %>%
  
  # Apply a clean theme
  # theme_booktabs() %>%
  
  # Automatically adjust column widths for content
  autofit() %>%
  
  # Manually add the descriptive names for the coefficients based on both the term and group
  compose(j = "term", 
          value = as_paragraph(
            case_when(
              term == "(Intercept)" ~ "Baseline Average Price",
              term == "sd__(Intercept)" ~ "Country-Level Price Variation",
              term == "sd__(cntry)" ~ "Country-Level Price Variation",  # Country-Level Random Effect
              term == "sd__(audience)" ~ "Target Audience-Level Price Variation",  # Audience-Level Random Effect
              term == "sd__(party)" ~ "Party-Level Price Variation",  # Audience-Level Random Effect
              term == "sd__Observation" ~ "Within-Country Price Variation",
              term == "sigma" ~ "Residual Variance",  # Fix for residual variance
              TRUE ~ as.character(term)
            )
          )) %>%
  # Add a layman's interpretation note
  add_footer_lines("Note: Baseline price is the average starting price across all countries. Price variation terms represent how much prices vary between countries, target audience characteristics, and parties. The within-country variation shows how much prices vary within countries for reasons not captured by the model.")  %>%  # Add ANOVA results to the footer
  add_footer_lines(anova_text(anova1, "1", "2"))   %>%  # Add ANOVA results to the footer
  add_footer_lines(anova_text(anova2, "2", "3")) 
```

```{r, results='hold'}
happens %>% flextable::save_as_html(path = "html/table1.html")

HTML(rvest::read_html("html/table1.html") %>% as.character())

# performance::r2_nakagawa(fit3)
```


Our statistical model suggests that country-level differences explain about 91.8% of the variance in ad prices. This is a huge effect, indicating that the country where an ad is placed is the single most important factor in determining its price.


### Price Variance Across Parties  (H2)

We added a random intercept for parties and conducted an LR-Test to check if including party accounts significantly increases the model's likelihood given the data.

Including party as a nested random effect within country significantly improves the model fit (p < 0.001). The random intercept for party nested within country has a standard deviation of 0.043, indicating some variability in ad pricing between parties within the same country.

The random intercept for party nested within country shows a standard deviation of 4.3 cents for reaching 1k users. Smaller than the country-level variability, this still indicates meaningful differences in ad pricing for different political parties within the same country. It is however also smaller what was found before in the Netherlands (6.5 cents).






